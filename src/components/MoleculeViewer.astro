---
// Property definitions
interface Props {
  xyzData: string;
  width?: string;
  height?: string;
  backgroundColor?: string;
  caption?: string;
}

// Get properties and set default values
const { 
  xyzData, 
  width = "100%", 
  height = "400px",
  backgroundColor = "white",
  caption
} = Astro.props;

// Generate a unique ID
const viewerId = `mol-viewer-${Math.random().toString(36).substring(2, 9)}`;
---

<!-- Viewer container -->
<figure class="molecule-viewer-container">
  <div 
    id={viewerId} 
    data-xyz={xyzData}
    data-bg-color={backgroundColor}
    style={`width:${width}; height:${height}; position:relative; border-radius:8px; overflow:hidden;`}>
  </div>
  {caption && <figcaption>{caption}</figcaption>}
</figure>

<!-- Load 3Dmol.js libraries -->
<script is:inline src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script is:inline src="https://3Dmol.org/build/3Dmol.ui-min.js"></script>

<!-- Molecule viewer initialization script -->
<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Find all molecule viewer containers
    const containers = document.querySelectorAll('[data-xyz]');
    
    containers.forEach((container) => {
      if (container.dataset.initialized) return;
      
      try {
        const xyzData = container.dataset.xyz;
        const backgroundColor = container.dataset.bgColor || 'white';
        
        // Initialize 3Dmol.js viewer
        const viewer = $3Dmol.createViewer(container, { 
          backgroundColor: backgroundColor 
        });

        // Add molecular model from XYZ data
        viewer.addModel(xyzData, "xyz");
        
        // Set molecular style - fix the colorscheme property
        viewer.setStyle({}, {
          sphere: { scale: 0.3, colorscheme: "Jmol" },
          stick: { radius: 0.15, colorscheme: "Jmol" }
        });

        // Optimize view and render
        viewer.zoomTo();
        viewer.render();
        
        // Mark as initialized
        container.dataset.initialized = 'true';
        
        console.log(`Molecule viewer initialized for container:`, container.id);
      } catch (error) {
        console.error(`Error initializing molecule viewer:`, error.message);
      }
    });
  });
</script>

<style>
  .molecule-viewer-container {
    margin: 2rem 0;
  }
  
  figcaption {
    text-align: center;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #666;
  }
</style>
