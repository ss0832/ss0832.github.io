---
interface Props {
  xyzData: string;
  width?: string;
  height?: string;
  backgroundColor?: string;
  caption?: string;
  showLabels?: boolean;
}

const {
  xyzData,
  width = "100%",
  height = "400px",
  backgroundColor = "white",
  caption,
  showLabels = true
} = Astro.props;

// Generate a unique ID
const viewerId = `mol-viewer-${Math.random().toString(36).substring(2, 9)}`;
---

<script is:inline src="/js/3Dmol-min.js"></script>

<figure class="molecule-viewer-container">
  <div id={viewerId} style={`width:${width}; height:${height}; position:relative; border-radius:8px; overflow:hidden;`}></div>
  {caption && <figcaption>{caption}</figcaption>}
</figure>

<script define:vars={{ xyzData, viewerId, backgroundColor, showLabels }} client:idle>
  function initViewer() {
    // Check if the viewer element exists and 3Dmol is loaded
    if (document.getElementById(viewerId) && window.$3Dmol) {
      try {
        // Initialize 3Dmol.js viewer
        const viewer = $3Dmol.createViewer(
          document.getElementById(viewerId),
          { backgroundColor: backgroundColor }
        );

        // Add molecular model from XYZ data
        viewer.addModel(xyzData, "xyz");

        // Set molecular style
        viewer.setStyle({}, {
          sphere: { scale: 0.3, colorscheme: "elem" },
          stick: { radius: 0.15, colorscheme: "elem" }
        });

        // Add atom labels with index and element symbol
        if (showLabels) {
          /*
           * [OPTIMIZATION]
           * Replaced the .forEach loop with viewer.addLabels (plural).
           * This is massively more performant as it creates a single
           * optimized render call instead of thousands of individual objects.
           */
          viewer.addLabels(
            // 1. Callback function to generate the label text for each atom
            (atom) => `${atom.index + 1}:${atom.elem}`,
            
            // 2. Options for the labels
            {
              // Use screen-space pixel offset (e.g., 5px right, 5px down)
              // This is more predictable than a 3D world-space offset.
              position: { x: 5, y: 5 }, 
              fontColor: "black",
              fontSize: 10.5,
              backgroundColor: "rgba(255,255,255,0.25)",
              // Must be true to show the backgroundColor
              showBackground: true, 
              alignment: "center",
              // Ensures labels are drawn in front of atoms
              inFront: true 
            }
          );
        }

        // Optimize view and render
        viewer.zoomTo();
        viewer.render();

        console.log(`Molecule viewer '${viewerId}' initialized successfully`);
      } catch (error) {
        console.error(`Molecule viewer initialization error: ${error.message}`);
      }
    } else {
      // Retry if element or 3Dmol not found (maintaining original logic)
      setTimeout(initViewer, 50);
    }
  }

  // Start initialization immediately
  initViewer();
</script>

<style>
  .molecule-viewer-container {
    margin: 2rem 0;
  }

  figcaption {
    text-align: center;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #666;
  }
</style>
