---
title:  【計算化学】自作pythonモジュールで遷移状態構造を求めてみる(SN2反応（基質-methyl trifluoromethanesulfonate, 求核剤-fluoride ion）, NNP使用）
published: 2025-08-19
description: ""
tags: [MultiOptPy, python]
category: Computational Chemistry
draft: false
---
最終更新：2025-08-19

import MoleculeViewer from '../../components/MoleculeViewer.astro';
import MultiDataGraph from '../../components/MultiDataGraph.astro';

## 概要

本記事では、自作モジュール(MultiOptPy)で、SN2反応（基質-methyl trifluoromethanesulfonate, 求核剤-fluoride ion）の遷移状態構造を算出してみる。使用する計算レベルは、Meta社のFAIR Chemistryが開発したニューラルネットワークポテンシャル(NNP)であるUMA(Meta’s Universal Model for Atoms)を使用する。

MultiOptPyは電子状態計算ソフトウェアを用いた分子構造最適化手法の勉強を目的として作成したpythonモジュールである。

MultiOptPyのレポジトリ:https://github.com/ss0832/MultiOptPy

SN2反応について：
- https://en.wikipedia.org/wiki/SN2_reaction

今回使用したニューラルネットワークポテンシャルについて：
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)



## 使用した自作モジュールMultiOptPyのバージョン
```
v1.12c
```
## 環境
```
Windows 11
```
※Windows 11環境下でAnaconda PowerShell Promptを使用した。

## Source codeのダウンロード
```
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.12c.zip
unzip v1.12c.zip
cd MultiOptPy-v1.12c
```

### 環境構築手順

今回は、Windows 11のPower Shellを使用した。初めに、NNPを使用できる環境が整ったAnaconda PowerShell Promptを用意する手順を説明する。

1, https://repo.anaconda.com/archive/ より、`Anaconda3-2025.06-1-Windows-x86_64.exe`でAnacondaをインストールする。

2, 検索機能を使い、スタートから`Anaconda PowerShell Prompt`を開く。

3, 以下のコマンドを実行し、仮想環境を作成する。
```
conda create -n (任意の仮想環境名) python=3.12.7
```

4, 先ほど作成した仮想環境を`conda activate (仮想環境名)`で起動させる。

5, 以下のコマンドを実行し、必要なライブラリを導入する。
```
pip install fairchem-core==2.2.0 ase==3.25.0 torch==2.6.0
```
- fairchem-coreは、FAIR Chemistryが管理しているNNPを動作させるために必要なライブラリである。
- aseはNNPに電子エネルギーを算出したい分子構造を渡すために必要なインターフェイスの役割を果たすために必要なライブラリである。
- torchはPyTorchライブラリを指す。これはニューラルネットワークなどの機械学習を行ったり、学習結果を扱ったりするために必須なライブラリである。

これで、`Anaconda PowerShell Prompt`から仮想環境を立ち上げることで、NNPを使用する準備が整えることが出来る。

次に、NNPを使用するために必要なModelの情報が保存されている`.pt`ファイルのダウンロードおよびNNPの自作モジュールへの導入方法について説明する。


1, 以下のサイトにアクセスして、`uma-s-1p1.pt`をダウンロードする。（使用許諾が下りていれば可能である。）
```
https://huggingface.co/facebook/UMA
```

2, ダウンロード後、`MultiOptPy-v1.12c`ディレクトリ内に存在する`software_path.conf`に対して、`uma-s-1p1.pt`の絶対パスを用いて以下を追記する。
```
uma-s-1p1::(uma-s-1p1.ptの絶対パス)
```

これで、`MultiOptPy-v1.12c`がNNP`uma-s-1p1`を使用できるようになる。


### 使用するNNPに関する具体的な説明

今回使用するNNPについて具体的に説明する。

- UMAのModel Checkpointは`uma-s-1p1`を使用した。
- 小分子系のトレーニングセットである`Omol25`(`omol`)を使用して学習したニューラルネットワークポテンシャルを使用する。

※自作モジュールでの具体的な使用の仕方に関しては、`ase_calculation_tools.py` を参照


## 手順

### 1. 初期構造の準備

モデル反応系として、以下の構造を用意した。今回はファイルの名前を`sn2_TfO_F.xyz`とした。
初期構造は以下のものを使用した。

```
13
OptimizedStructure
C     -1.397191095072     -0.503357183150      0.812700352725
H     -1.275480258399     -1.573355838428      0.669452231922
H     -1.074937104241     -0.192948081206      1.803741774349
H     -2.428050081873     -0.212143918950      0.652264634483
O     -0.639231977547      0.209550759498     -0.197220664975
F     -2.224768956906     -1.991056691866      3.353635027375
S      0.921855415126      0.127148446561     -0.061265529786
O      1.387530637631      0.989143892904      0.970578168528
O      1.364685860616     -1.223721479809     -0.143594728573
C      1.266598487840      0.945578341758     -1.675913284471
F      2.574721006165      1.161272565667     -1.733141545725
F      0.622030392065      2.100172002919     -1.769294657694
F      0.902237674595      0.163717184100     -2.681941778158

```

<MoleculeViewer 
  xyzData={`13
OptimizedStructure
C     -1.397191095072     -0.503357183150      0.812700352725
H     -1.275480258399     -1.573355838428      0.669452231922
H     -1.074937104241     -0.192948081206      1.803741774349
H     -2.428050081873     -0.212143918950      0.652264634483
O     -0.639231977547      0.209550759498     -0.197220664975
F     -2.224768956906     -1.991056691866      3.353635027375
S      0.921855415126      0.127148446561     -0.061265529786
O      1.387530637631      0.989143892904      0.970578168528
O      1.364685860616     -1.223721479809     -0.143594728573
C      1.266598487840      0.945578341758     -1.675913284471
F      2.574721006165      1.161272565667     -1.733141545725
F      0.622030392065      2.100172002919     -1.769294657694
F      0.902237674595      0.163717184100     -2.681941778158
`}
  caption="初期パスを求めるための初期構造"
  backgroundColor="#333333"
/>


### 2. 遷移状態構造最適化のための初期構造の算出


#### a. 初期構造をカレントディレクトリに`sn2_TfO_F.xyz`として保存し、以下を実行する。
```
python .\optmain.py sn2_TfO_F.xyz -opt rsirfo_fsb -os uma-s-1p1 -ma 300 1 6 -elec -1   
```
- `-opt rsirfo_fsb`は準ニュートン法であるRS-I-RFO法を構造最適化に使用することを示す。初期のへシアンに関しては、特にオプションで指定しない限り、単位行列が使われる。
- `-spin`はスピン多重度の指定である。PySCFを使用するときは目的とするスピン多重度に1を引いた値を指定する。（デフォルトでは1が指定される。）
- `-elec M`は形式電荷をMとすることを示す。（デフォルトでは0が指定される。）
- `-ma yyy a b `はyyykJ/molの活性化障壁を超えうるペア同士を近づける力を原子のラベル番号aとbのペアに構造最適化時に加えることを示す。
- `-os uma-s-1p1`は今回使用するNNPを指定している。これを使用する際にASEライブラリが必要である。

これを実行すると、`omol`のデータセットを使用した`uma-s-1p1`モデルのNNPで得たエネルギーに対して、指定した人工力ポテンシャルを加えた上で初期構造を構造最適化することができる。

結果は`yyyy_mm_dd`（今日の年月日）ディレクトリの中に存在するディレクトリを開いて確認できる。

正常終了していれば、このディレクトリ中に、`sn2_TfO_F_traj.xyz`が存在するので、これをコピーして、`MultiOptPy-v1.12c`ディレクトリに置く。

`sn2_TfO_F_traj.xyz`は構造最適化の過程をAvogadro（公式ページ:https://avogadro.cc/ ）等で可視化して確認できるようにしている。この`sn2_TfO_F_traj.xyz`は次のNEB計算に使用する。

※`sn2_TfO_F_traj.xyz`をアニメーションとして表示したい場合は、[https://github.com/ss0832/molecule_movie] を使うと良い。

（この人工力ポテンシャルを加えて行った構造最適化の結果は`sn2_TfO_F_optimized.xyz`で確認できる。構造を可視化して、生成系になっているか確認する。反応系のままであれば、`-ma`の設定を見直してb.をやり直す。今回の場合以下の構造が得られた。生成系の安定構造に近いものが得られていると判断できるため、次のNEB計算を行うことが可能である。）



#### b. `sn2_TfO_F_traj.xyz`を初期パスとして、NEB法で経路の緩和を行う。

NEB法を用いることで、先ほど得られた`sn2_TfO_F_traj.xyz`全体のエネルギーを下げることができる。これにより、パスのエネルギー極大値を持つ構造を遷移状態構造に近づける。（この時点ではまだ正確な遷移状態構造は求められていない。）


```
python .\nebmain.py sn2_TfO_F_traj.xyz -os uma-s-1p1 -ns 20 -modelhess -spng -nd 0.12 -elec -1
```
- `-nd N`はノード間の距離をN Åとして初期パスを作成することを示す。
- `-ns n`はn回分NEB法による経路の緩和を行うことを示す。
- `-fc M`はM回あたりの経路緩和回数に対して1回だけ正確なHessianを計算し、経路緩和に使用する。これを使用すると、Hessianを使用しない場合の経路緩和アルゴリズムとは別のものを使用して、経路緩和を行う。
- `-spng`は緩和中のパスのエネルギープロファイルや各ノードの勾配のRMS値をmatplotlibで可視化するオプションである。
- `-os uma-s-1p1`は今回使用するNNPを指定している。これを使用する際にASEライブラリが必要である。



#### c. 初期構造の決定及び遷移状態構造の計算

`MultiOptPy-v1.12c`と同じディレクトリ内に、NEBという名前を含むディレクトリが生成されている。
そのディレクトリ内の`energy_plot.csv`を確認し、緩和後のパスのエネルギー極大値を示す構造を確認する。

パスの緩和後の各ノードのエネルギー一覧(単位:hartree) (energy_plot.csvに保存されている。)

export const dataset1 = [-1101.3853792705847,-1101.3853792705847,-1101.3876091453378,-1101.3862610608357,-1101.3850871680493,-1101.3850894942855,-1101.3864343807604,-1101.3899525807176,-1101.395512482201,-1101.4028172666804,-1101.4102790436225,-1101.412401092293,-1101.3938019100926,-1101.4108871769452,-1101.4132803613597,-1101.4210794775875,-1101.4347792472731,-1101.4438112686482,-1101.4531228019703,-1101.4595185056373,-1101.4627668600133,-1101.464672507392,-1101.4662831740109,-1101.4679556370268,-1101.4691908289826,-1101.4701144980554,-1101.4708530057417,-1101.4715088203336,-1101.4720193831645,-1101.4729177221104];

export const dataset_itr5 = [-1101.393157866869,-1101.3881080375604,-1101.3902004825761,-1101.3906875727646,-1101.3911768292878,-1101.3913086318116,-1101.391736210221,-1101.3975293749224,-1101.4079199335292,-1101.4203510239727,-1101.4315020098936,-1101.4342511478635,-1101.4284623727829,-1101.4316208801217,-1101.4337173226713,-1101.4472895129811,-1101.4542552452592,-1101.4592161387493,-1101.4635034401217,-1101.466676969426,-1101.4671444859366,-1101.468478220935,-1101.4703340404233,-1101.4715332041947,-1101.4726364534395,-1101.4738286779304,-1101.4748686763328,-1101.4756371929032,-1101.476162641893,-1101.4771785806179];

export const dataset1_itr10 = [-1101.396475907569,-1101.3906906481275,-1101.3926853517983,-1101.3934088287574,-1101.3942874625996,-1101.3949686839833,-1101.3959885632908,-1101.4106450030597,-1101.4279638748376,-1101.4426502709202,-1101.4485829440766,-1101.4485910048572,-1101.4546217303996,-1101.4472044980314,-1101.4489523381073,-1101.457621821496,-1101.4614659814576,-1101.4658415659005,-1101.4678086504457,-1101.470592852811,-1101.4706202945117,-1101.4716298722294,-1101.4727726543456,-1101.4737376699654,-1101.4745718906593,-1101.4753772414922,-1101.4760496244926,-1101.476541568673,-1101.4767986550023,-1101.4773031459627];

export const dataset1_itr15 = [-1101.3973342383201,-1101.3927262777831,-1101.3943799074862,-1101.3946231765863,-1101.395593663899,-1101.3961874170518,-1101.403378787663,-1101.4310870855954,-1101.4483160709083,-1101.4568701887563,-1101.4563476223718,-1101.4580739261446,-1101.4630708916277,-1101.456040147402,-1101.456186240288,-1101.464067834948,-1101.4654111289806,-1101.4694986631828,-1101.4699450376677,-1101.4724504421665,-1101.4721233497103,-1101.4735680431052,-1101.474311877916,-1101.4749971318804,-1101.4756335217435,-1101.4762152122012,-1101.4766921738435,-1101.4769880745837,-1101.4770660976824,-1101.4772897843427];

export const dataset2 = [-1101.3975809704893,-1101.3937009904344,-1101.3950708719,-1101.3950732507067,-1101.3964726766856,-1101.396973726481,-1101.4184834900673,-1101.4522899481044,-1101.4604400543742,-1101.4626511264803,-1101.462715700342,-1101.4647085618615,-1101.4670553529795,-1101.4623606492437,-1101.4623298430433,-1101.4674871129187,-1101.468469608166,-1101.4715370943975,-1101.4718511494173,-1101.473390329179,-1101.472975374215,-1101.4747373907503,-1101.4753090578026,-1101.475830450117,-1101.4763338633861,-1101.4767802466329,-1101.4770952479182,-1101.477157920487,-1101.4771760660049,-1101.4773262681365];

<MultiDataGraph datasets={[ { data: dataset1, label: "緩和前の経路のエネルギー", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_itr5, label: "ITR. 5の経路のエネルギー", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_itr10, label: "ITR. 10の経路のエネルギー", color: "rgba(153, 212, 37, 1)" }, { data: dataset1_itr15, label: "ITR. 15の経路のエネルギー", color: "rgba(13, 226, 148, 1)" }, { data: dataset2, label: "緩和後の経路のエネルギー", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="Electronic Energy [hartree]" height="500px" />

export const dataset1_grad = [0.007470692858593547,0.007470692998595434,0.005681315422458674,0.008841799395395613,0.00928188127370152,0.008051513721139002,0.006661078658488261,0.006720711845210841,0.008660447843740154,0.011953309326328949,0.014882341524418656,0.01726485820962063,0.032532409026093397,0.019707152371481584,0.02160812259717139,0.023549378450037083,0.018717046520313085,0.015487377356568851,0.01271739810366025,0.012812723136387778,0.014015635621141666,0.01373094236611773,0.014094727441347677,0.013676937084567214,0.013434123481508293,0.013334913689930361,0.013362047234838081,0.01331234089151601,0.01322500422402539,0.013057793290852006];

export const dataset1_grad_itr5 = [0.005379595357047199,0.0038323383458599785,0.003739380242319489,0.005188611838373224,0.005544188905234786,0.005127151403223989,0.003572017870477978,0.006485655913469461,0.010699333770999237,0.01331316141066382,0.013254351393889542,0.012844644358106092,0.020290054650335933,0.014372348638041398,0.013640014923913877,0.010412819767650006,0.009009571554088507,0.007886380504739093,0.005887137032451407,0.0065411642409309015,0.010283586218070045,0.010389532959086626,0.009595021191019208,0.00932404959960526,0.00876379369200895,0.007711173696451884,0.006602928324254361,0.0056046503565956194,0.004673075932933651,0.0011943774370588476];

export const dataset1_grad_itr10 = [0.003870615893590606,0.0028657997533324837,0.0028018113309220107,0.0032068434812657825,0.002984750051955661,0.0022673769497090386,0.0031861906507797255,0.01090853541770392,0.013676634329155023,0.011872586382854915,0.009800605998421877,0.010180119900879405,0.007960262501236515,0.01015143333553755,0.00954792830876395,0.0075033763538634975,0.007041325884205526,0.006045477490637909,0.004641669063745258,0.0024384678269732257,0.006165331199658503,0.007031760452368427,0.007007401206136965,0.006648925197630613,0.006076814477921145,0.005170870116926042,0.004161492098218992,0.003164705787699831,0.0025064600217894386,0.0005026760535643912];

export const dataset1_grad_itr15 = [0.003396530596365072,0.002375804532353841,0.0019584646737187666,0.002065734390110825,0.0018195739000406888,0.0013086201997027918,0.00726649849120517,0.014043891482202113,0.01102201536468436,0.0067296346369451615,0.0069503894948176985,0.00813614664745732,0.005732124075782437,0.007800583673098757,0.007526450459204271,0.005851639507721617,0.005398388827202619,0.004760232506386347,0.004089711559436985,0.0016590699316475508,0.0038569721962192615,0.004875370512010582,0.005210285937422657,0.005049944778136715,0.004432215356270568,0.00352729415521124,0.002419722733031801,0.0013616773437503905,0.0008536419717109323,0.0006604917187878114];

export const dataset2_grad = [0.001695585124253321,0.0019183788050761601,0.0011634861936844466,0.0012280378272239345,0.0013461332480011854,0.0008383427761281335,0.012609427095576595,0.010609192718244448,0.005638580681610728,0.0043447304524526905,0.004686284051806892,0.006426259016615004,0.004591278121427866,0.006093064908604893,0.005830729448163213,0.004799391281806402,0.003987892121157463,0.003913765826338172,0.00306666146447064,0.0015206910420032616,0.0020996117204862227,0.0038613240219169316,0.004040617271847653,0.0038313723502945104,0.003083008998744646,0.0020687308741666943,0.0007782299498178988,0.0005061189246228201,0.0004394681570088593,0.000552911200915117];

<MultiDataGraph datasets={[ { data: dataset1_grad, label: "緩和前の経路の勾配のRMS値", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_grad_itr5, label: "ITR. 5の経路の勾配のRMS値", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_grad_itr10, label: "ITR. 10の経路の勾配のRMS値", color: "rgba(153, 212, 37, 1)" }, { data: dataset1_grad_itr15, label: "ITR. 15の経路の勾配のRMS値", color: "rgba(13, 226, 148, 1)" }, { data: dataset2_grad, label: "緩和後の経路の勾配のRMS値", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="RMS of gradient [hartree/Bohr]" height="500px" />

※`bias_force_rms.csv`にて、各Iterationごとのすべてのノードの勾配のRMS値を確認できる。

経路緩和の結果、経路のエネルギー極大値を示す構造付近の勾配のRMS値の極小値を示す構造の中から目視で、ITR. 5の経路の6番(グラフ上では7番)の構造を遷移状態構造を求める初期構造として採用して遷移状態構造を求めようとした。


※こちら[https://ss0832.github.io/molecule_viewer/] を使うことでも可視化は可能である。


`sn2_TfO_F_traj_6_itr5.xyz`
```
13
-1 1
C      -1.511561824733     -0.650405908653      1.059011640615
H      -1.277774648086     -1.644658308534      0.744044920760
H      -1.061812058260     -0.218725100586      1.922250957206
H      -2.459040967070     -0.255533119587      0.726864313635
O      -0.623742469011      0.202616392612     -0.198204112761
F      -2.133182708110     -1.719876830408      2.874123820794
S       0.867675848268      0.125010746229     -0.057197606459
O       1.401601477930      0.991673376997      0.951692701267
O       1.385886912357     -1.207186879224     -0.156587548376
C       1.272470916866      0.935556352985     -1.653949590552
F       2.586370894415      1.162979650694     -1.750239038706
F       0.642358126611      2.109612552660     -1.773279459566
F       0.910750498823      0.168937074816     -2.688530997858

```


<MoleculeViewer 
  xyzData={`13
-1 1
C      -1.511561824733     -0.650405908653      1.059011640615
H      -1.277774648086     -1.644658308534      0.744044920760
H      -1.061812058260     -0.218725100586      1.922250957206
H      -2.459040967070     -0.255533119587      0.726864313635
O      -0.623742469011      0.202616392612     -0.198204112761
F      -2.133182708110     -1.719876830408      2.874123820794
S       0.867675848268      0.125010746229     -0.057197606459
O       1.401601477930      0.991673376997      0.951692701267
O       1.385886912357     -1.207186879224     -0.156587548376
C       1.272470916866      0.935556352985     -1.653949590552
F       2.586370894415      1.162979650694     -1.750239038706
F       0.642358126611      2.109612552660     -1.773279459566
F       0.910750498823      0.168937074816     -2.688530997858
`}
  caption="NEB法により緩和した経路から得られた遷移状態構造を求めるための初期構造"
  backgroundColor="#333333"
/>

しかしながら、うまくいかなかったため、エネルギー極大値をとる構造付近の勾配のRMS値の最小値をとる構造の生成物側で1つ隣のノードを使用したが、これもうまくいかなかった。

`sn2_TfO_F_traj_7_itr5.xyz`
```
13
-1 1
C      -1.575460305272     -0.714185348066      1.158231034818
H      -1.269353581918     -1.651900118057      0.744578804961
H      -1.043644517785     -0.208711249385      1.930561658658
H      -2.458981422539     -0.255020465798      0.726210884846
O      -0.615041927582      0.212337926513     -0.210027635310
F      -2.119304922788     -1.677300748695      2.795380247976
S       0.859396123617      0.127858674309     -0.061838792554
O       1.403964116075      0.991756277847      0.948840207173
O       1.385155896589     -1.205188636698     -0.159900305408
C       1.279187943066      0.934154650101     -1.651154105068
F       2.591312674040      1.164924178761     -1.753679551305
F       0.647486150382      2.110899949870     -1.776153011157
F       0.915283774116      0.170374909299     -2.691049437631

```


<MoleculeViewer 
  xyzData={`13
-1 1
C      -1.575460305272     -0.714185348066      1.158231034818
H      -1.269353581918     -1.651900118057      0.744578804961
H      -1.043644517785     -0.208711249385      1.930561658658
H      -2.458981422539     -0.255020465798      0.726210884846
O      -0.615041927582      0.212337926513     -0.210027635310
F      -2.119304922788     -1.677300748695      2.795380247976
S       0.859396123617      0.127858674309     -0.061838792554
O       1.403964116075      0.991756277847      0.948840207173
O       1.385155896589     -1.205188636698     -0.159900305408
C       1.279187943066      0.934154650101     -1.651154105068
F       2.591312674040      1.164924178761     -1.753679551305
F       0.647486150382      2.110899949870     -1.776153011157
F       0.915283774116      0.170374909299     -2.691049437631
`}
  caption="NEB法により緩和した経路から得られた遷移状態構造を求めるための初期構造"
  backgroundColor="#333333"
/>

そこで以下のような操作を行った。
a, `sn2_TfO_F_optimized.xyz`を`sn2_TfO_F_reverse.xyz`に改名して以下のようなコマンドを実行した。
```
python .\optmain.py .\sn2_TfO_F_reverse.xyz -opt fire -os uma-s-1p1 -ma 465 1 5 -elec -1 -ns 120
```
- `-opt fire`はFIREと呼ばれる最急降下法と似た連続最適化アルゴリズムを用いて構造最適化を行うことを指定する。準ニュートン法だと、経験上構造最適化途中にエネルギーが上がることがあるので、時間をかけてもエネルギーを確実に下げたいときに使用する。

`sn2_TfO_F_reverse.xyz`
```
13
OptimizedStructure
C     -1.897507649579     -1.095752431252      1.777177253589
H     -1.359856126639     -1.800472537204      1.143734781875
H     -1.162595454619     -0.421467690576      2.222699471455
H     -2.578216498150     -0.518712844367      1.147996749121
O     -0.583031904297      0.405267695015     -0.486886653381
F     -2.570533037711     -1.743202183440      2.719345066672
S      0.847662941267      0.291905918664     -0.289621221682
O      1.397541724792      1.142135344544      0.742882304827
O      1.370091193190     -1.055964554320     -0.338915021399
C      1.503511478737      1.045206379481     -1.842246655769
F      2.845906745211      1.128164363572     -1.841413327401
F      1.032768955558      2.291556077671     -2.027398692353
F      1.154257632240      0.331336462213     -2.927354055555

```
<MoleculeViewer 
  xyzData={`13
OptimizedStructure
C     -1.897507649579     -1.095752431252      1.777177253589
H     -1.359856126639     -1.800472537204      1.143734781875
H     -1.162595454619     -0.421467690576      2.222699471455
H     -2.578216498150     -0.518712844367      1.147996749121
O     -0.583031904297      0.405267695015     -0.486886653381
F     -2.570533037711     -1.743202183440      2.719345066672
S      0.847662941267      0.291905918664     -0.289621221682
O      1.397541724792      1.142135344544      0.742882304827
O      1.370091193190     -1.055964554320     -0.338915021399
C      1.503511478737      1.045206379481     -1.842246655769
F      2.845906745211      1.128164363572     -1.841413327401
F      1.032768955558      2.291556077671     -2.027398692353
F      1.154257632240      0.331336462213     -2.927354055555`}
  caption="  "
  backgroundColor="#333333"
/>

b, 前のコマンドで得られたITR. 105の構造を記録したファイル`sn2_TfO_F_reverse_0.xyz`を`sn2_TfO_F_reverse_itr105.xyz`に改名して以下のコマンドを実行した。

```
python .\optmain.py .\sn2_TfO_F_reverse_itr105.xyz -opt fire -os uma-s-1p1  -elec -1 -ns 120
```
`sn2_TfO_F_reverse_itr105.xyz`
```
13
-1 1
C      -1.300518756379     -0.586193055337      0.967823990509
H      -1.181623012881     -1.668956322503      0.907693854227
H      -1.026471075608     -0.243925991362      1.968108697102
H      -2.341693141130     -0.333932169545      0.788543365695
O      -0.588372240255      0.053021970705     -0.013398668219
F      -2.614029408724     -1.592946480837      2.526333197407
S       0.944547869816      0.118681919332     -0.025751689109
O       1.445596062743      1.054286872172      0.927771220091
O       1.542034242555     -1.169330392616     -0.166304689580
C       1.200020090335      0.937806751520     -1.662431855159
F       2.522749288990      1.085294340393     -1.806109726621
F       0.641897202276      2.145188555490     -1.733083730600
F       0.755862878262      0.201004002587     -2.679193965743

```
<MoleculeViewer 
  xyzData={`13
-1 1
C      -1.300518756379     -0.586193055337      0.967823990509
H      -1.181623012881     -1.668956322503      0.907693854227
H      -1.026471075608     -0.243925991362      1.968108697102
H      -2.341693141130     -0.333932169545      0.788543365695
O      -0.588372240255      0.053021970705     -0.013398668219
F      -2.614029408724     -1.592946480837      2.526333197407
S       0.944547869816      0.118681919332     -0.025751689109
O       1.445596062743      1.054286872172      0.927771220091
O       1.542034242555     -1.169330392616     -0.166304689580
C       1.200020090335      0.937806751520     -1.662431855159
F       2.522749288990      1.085294340393     -1.806109726621
F       0.641897202276      2.145188555490     -1.733083730600
F       0.755862878262      0.201004002587     -2.679193965743
`}
  caption="  "
  backgroundColor="#333333"
/>

結果を以下に示す。

export const path = [-1101.3825959246774,
-1101.3826359777759,
-1101.3827158003126,
-1101.3828347384438,
-1101.3829917199548,
-1101.3831855236806,
-1101.3834145155613,
-1101.3836769060158,
-1101.3840034661976,
-1101.384404855832,
-1101.3848918605936,
-1101.3854748171195,
-1101.3861623097027,
-1101.386959527471,
-1101.3878663149035,
-1101.3888748937852,
-1101.38996723031,
-1101.391113585017,
-1101.3922720768935,
-1101.3933917499785,
-1101.3944191490307,
-1101.3953098061404,
-1101.396041604541,
-1101.3966202941103,
-1101.3970701338546,
-1101.3974149665994,
-1101.397671606081,
-1101.3978623377297,
-1101.3980285694245,
-1101.3982272413798,
-1101.3985244344733,
-1101.3990202491425,
-1101.39991278126,
-1101.401549774651,
-1101.4044300404923,
-1101.409441064152,
-1101.4190583332422,
-1101.435593447441,
-1101.4558513849497,
-1101.455736203405,
-1101.4577064071218,
-1101.4605835275063,
-1101.4630117412696,
-1101.4641324088097,
-1101.4639690553392,
-1101.4640082202188,
-1101.4640838864154,
-1101.464191147367,
-1101.4643231514103,
-1101.4644718377647,
-1101.4646286462316,
-1101.4647855861244,
-1101.4649514016373,
-1101.4651186365488,
-1101.465282296679,
-1101.4654457377667,
-1101.4656256946926,
-1101.4658511599816,
-1101.4661520023308,
-1101.4665381662896,
-1101.4669821225405,
-1101.4674339906226,
-1101.4678910105947,
-1101.4684281214313,
-1101.4690952999715,
-1101.469826684381,
-1101.4705298210117,
-1101.4712664536903,
-1101.4720194532583,
-1101.4726640002807,
-1101.4732711960996,
-1101.4738738095398,
-1101.474370169626,
-1101.4748228700712,
-1101.4752537976472,
-1101.4755935683095,
-1101.4759034527515,
-1101.4761554222375,
-1101.4763337319603,
-1101.4764956923175,
-1101.4765888644267,
-1101.4766717064704,
-1101.4767509649712,
-1101.476790121089,
-1101.476835787163,
-1101.4768579280246,
-1101.4768596015126,
-1101.4768624315475,
-1101.4768654280551,
-1101.476867793719,
-1101.4768692043556,
-1101.4768700016718,
-1101.4768710267929,
-1101.476873006941,
-1101.4768761611597,
-1101.476880033839,
-1101.476883512241,
-1101.4768860881861,
-1101.4768892424047,
-1101.4768935882169,
-1101.476896935193,
-1101.476898740107,
-1101.4769009568215,
-1101.476902963255,
-1101.4769036291457,
-1101.4769037255244,
-1101.4769039796142];

<MultiDataGraph datasets={[ { data: path, label: "エネルギー変化", color: "rgba(75, 192, 192, 1)" }]} title="構造最適化の結果のエネルギー変化の可視化" xLabel="# NODE" yLabel="Energy [hartree]" height="500px" />

構造最適化の結果
```
13
OptimizedStructure
C     -1.927086981613     -1.073086342294      1.723136702839
H     -1.366831081267     -1.819625340378      1.167028798524
H     -1.245166080738     -0.393938041283      2.227576119285
H     -2.576359300860     -0.517676251288      1.052706538680
O     -0.503691597723      0.335393773851     -0.364533794898
F     -2.719690800809     -1.721748597992      2.689001387479
S      0.941060182542      0.276226969763     -0.252120356174
O      1.519826538813      1.152811273399      0.741980328853
O      1.510948423435     -1.051336917438     -0.328422482243
C      1.482853998376      1.046706277557     -1.841405982691
F      2.822531514075      1.128608088478     -1.929874074085
F      1.001867888419      2.295479802532     -1.978719240123
F      1.059737297351      0.342185305093     -2.906353945444

```
<MoleculeViewer 
  xyzData={`13
OptimizedStructure
C     -1.927086981613     -1.073086342294      1.723136702839
H     -1.366831081267     -1.819625340378      1.167028798524
H     -1.245166080738     -0.393938041283      2.227576119285
H     -2.576359300860     -0.517676251288      1.052706538680
O     -0.503691597723      0.335393773851     -0.364533794898
F     -2.719690800809     -1.721748597992      2.689001387479
S      0.941060182542      0.276226969763     -0.252120356174
O      1.519826538813      1.152811273399      0.741980328853
O      1.510948423435     -1.051336917438     -0.328422482243
C      1.482853998376      1.046706277557     -1.841405982691
F      2.822531514075      1.128608088478     -1.929874074085
F      1.001867888419      2.295479802532     -1.978719240123
F      1.059737297351      0.342185305093     -2.906353945444
`}
  caption="  "
  backgroundColor="#333333"
/>

生成物の構造をSN2反応の遷移状態構造を経由して反応物の構造で収束した。本記事の操作では遷移状態構造を見つけることはできなかった。

## 終わりに
　
　自作モジュールで、UMAモデルのニューラルネットワークポテンシャル(NNP)を用いて、SN2反応（基質-methyl Trifluoromethanesulfonate, 求核剤-fluoride ion）のある1つの遷移状態構造の算出を試行した。


## 参考
- https://github.com/ss0832/MultiOptPy (自作モジュールMultiOptPyのレポジトリ)
- https://avogadro.cc/ (Avogadro、分子構造可視化ツール)
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)
- _The Journal of Chemical Physics_ 2010, 132, 241102.
- _The Journal of Chemical Physics_ 1991, 94, 751–760.
- In _Classical and Quantum Dynamics in Condensed Phase Simulations_; WORLD SCIENTIFIC: LERICI, Villa Marigola, 1998; pp 385–404.
- _The Journal of Chemical Physics_, 2020, 153, 024109.
- _The Journal of Chemical Physics_, 2022, 144, 214108.


### 個人的な技術的補足

`-modelhess`を使わない場合のアルゴリズムを用いた`nebmain.py`による経路緩和の結果

#### コマンド
```
python .\nebmain.py sn2_TfO_F_traj.xyz -os uma-s-1p1 -ns 20 -spng -nd 0.12 -elec -1
```

#### 結果

パスの緩和後の各ノードのエネルギー一覧(単位:hartree) (energy_plot.csvに保存されている。)

export const dataset1_nomh = [-1101.3853792705847,-1101.3853792705847,-1101.3876091453378,-1101.3862610608357,-1101.3850871680493,-1101.3850894942855,-1101.3864343807604,-1101.3899525807176,-1101.395512482201,-1101.4028172666804,-1101.4102790436225,-1101.412401092293,-1101.3938019100926,-1101.4108871769452,-1101.4132803613597,-1101.4210794775875,-1101.4347792472731,-1101.4438112686482,-1101.4531228019703,-1101.4595185056373,-1101.4627668600133,-1101.464672507392,-1101.4662831740109,-1101.4679556370268,-1101.4691908289826,-1101.4701144980554,-1101.4708530057417,-1101.4715088203336,-1101.4720193831645,-1101.4729177221104];

export const dataset_itr5_nomh = [-1101.3871429452754,-1101.3854766329855,-1101.3877436508515,-1101.386763356986,-1101.3854502120248,-1101.385383642682,-1101.38679734369,-1101.3905971562158,-1101.3968187097855,-1101.405346656382,-1101.4153689227442,-1101.4211660302187,-1101.4055722049075,-1101.4194383508561,-1101.4267976507447,-1101.4381441850687,-1101.4451041565173,-1101.4514518459698,-1101.457911326182,-1101.4621822343802,-1101.4634712933785,-1101.465127950255,-1101.4673355001505,-1101.468623463934,-1101.4696532899818,-1101.4707972636918,-1101.4717933220786,-1101.4724045482876,-1101.4726031238642,-1101.476805129912];

export const dataset1_itr10_nomh = [-1101.3876662717391,-1101.3857718108839,-1101.387828797227,-1101.3870330820935,-1101.3857804937463,-1101.3856429172504,-1101.387042774744,-1101.3910831205235,-1101.3979152322213,-1101.4084038651183,-1101.4205048534554,-1101.4322263148351,-1101.4334554831098,-1101.4334668163922,-1101.437446423752,-1101.443201794783,-1101.4505250927723,-1101.4558847232865,-1101.460450340631,-1101.4647213276846,-1101.4653890494512,-1101.4666015135108,-1101.4682699461364,-1101.4694617851117,-1101.47032525242,-1101.4713419096058,-1101.4723101670613,-1101.473023248242,-1101.4733386963749,-1101.4769181648358];

export const dataset1_itr15_nomh = [-1101.388270322101,-1101.3864900395738,-1101.3880586696603,-1101.3875989598405,-1101.38628698895,-1101.3860535986867,-1101.3873792838565,-1101.3916026597344,-1101.3991488251636,-1101.4107200384126,-1101.4258205308115,-1101.4412698184417,-1101.4507805581839,-1101.4404829986424,-1101.4435542786978,-1101.4482334391457,-1101.4535516793044,-1101.4581271185345,-1101.4615710607416,-1101.4656093540884,-1101.4667457751975,-1101.468826683221,-1101.470007570049,-1101.470722412335,-1101.4717004391061,-1101.4721722751435,-1101.472846156398,-1101.4733969004676,-1101.4737605993814,-1101.4769551217623];

export const dataset2_nomh = [-1101.3892080362077,-1101.3866783989872,-1101.3883057917258,-1101.3895805406482,-1101.3872236209843,-1101.3867796515908,-1101.3878756789895,-1101.3920870206478,-1101.4000337280152,-1101.4125749160164,-1101.4279547363656,-1101.4445195221224,-1101.4555841963595,-1101.4443691535182,-1101.447558611626,-1101.4529093139495,-1101.4582972623364,-1101.4618931590185,-1101.4637271530673,-1101.465804670306,-1101.4672129061923,-1101.4695353923046,-1101.4705263688948,-1101.4713872514965,-1101.4733215672163,-1101.47354695365,-1101.4751114022065,-1101.4750866153063,-1101.4749412145961,-1101.4769906680522];

<MultiDataGraph datasets={[ { data: dataset1_nomh, label: "緩和前の経路のエネルギー", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_itr5_nomh, label: "ITR. 5の経路のエネルギー", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_itr10_nomh, label: "ITR. 10の経路のエネルギー", color: "rgba(153, 212, 37, 1)" }, { data: dataset1_itr15_nomh, label: "ITR. 15の経路のエネルギー", color: "rgba(13, 226, 148, 1)" }, { data: dataset2_nomh, label: "緩和後の経路のエネルギー", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="Electronic Energy [hartree]" height="500px" />

export const dataset1_grad_nomh = [0.007470692936228248,0.007470692311370792,0.0056813158119244835,0.008841799499082032,0.009281881738757741,0.008051513538950788,0.006661077821415423,0.006720711709666538,0.008660447626701467,0.011953309863493987,0.014882340879546168,0.017264857274840808,0.032532407053987994,0.019707152303039776,0.021608121092228164,0.023549377874028603,0.01871704657821825,0.015487376270391694,0.012717397692287694,0.012812722981776974,0.014015636702504925,0.01373094206600595,0.014094727803958474,0.01367693687082369,0.01343412362551471,0.01333491386950824,0.013362047439332647,0.013312341241783342,0.013225004180775633,0.013057793837478243];

export const dataset1_grad_itr5_nomh = [0.0024833061190820053,0.007243837099578265,0.004979226256658999,0.007697640602048548,0.008315364730011203,0.007223575766324119,0.005616714654381617,0.005799350843100789,0.008089913915193737,0.011584695007315236,0.014393364125784265,0.01565221719466876,0.030305263208688857,0.01814595928913912,0.015182763600156633,0.01293643092560725,0.011945711781790457,0.010605522773823862,0.008240975901994782,0.009943963432413265,0.013332249413756709,0.013511026787122692,0.01278467151276,0.012877310370410743,0.01295003156423098,0.012538513154767764,0.01212132600629579,0.012051728531886515,0.01237152941012192,0.0014377631668679443];

export const dataset1_grad_itr10_nomh = [0.0018519608147337786,0.006444840506196124,0.0049447282069515295,0.007388928900774732,0.00803304461574976,0.007030911015330938,0.0053660489364882645,0.005665413990524723,0.007982525209924544,0.011445837232967349,0.014373041231616587,0.013230472283768798,0.018111485282826842,0.01376849743946255,0.012544506176819603,0.01100615567834268,0.01003206481833605,0.00946982679866696,0.007002941256496906,0.0058444753779168575,0.010341627169692204,0.011342482952751788,0.011273640550492226,0.011737877993615465,0.012137794076159664,0.011930443677636522,0.011449826123264286,0.011045687583866764,0.011053877709627445,0.0005345644549665723];

export const dataset1_grad_itr15_nomh = [0.0017058341933903372,0.0036348884903149906,0.004973136376032304,0.007255207818282172,0.007832945682569514,0.006889938164187097,0.00508268279925878,0.005466192122046976,0.007819662277336631,0.011378565947479168,0.013654540298167487,0.011883362441732447,0.00867544463508319,0.011376251840771385,0.01044404526312376,0.009236373845295172,0.00852132419944155,0.008327073749371049,0.006843563198671136,0.003816900596632375,0.0074715619012806645,0.006603372036992293,0.007493143217247978,0.008914182300216003,0.009154530070799274,0.010350655452924,0.010563787876366177,0.010401527289940538,0.010196716929596969,0.00036356874018601853];

export const dataset2_grad_nomh = [0.00160914344749616,0.0030874204812451228,0.004605157175339015,0.004741563397823379,0.007277253512160096,0.006597098939366256,0.004791277840261127,0.005302831768554963,0.00793361614578225,0.011517099505081386,0.013827971722733706,0.011379970762054376,0.006874372111659145,0.010166638399712099,0.00920394407091193,0.007600180942942995,0.005996926351821441,0.004988564391483963,0.00594685690246356,0.003459739701229239,0.006552477621354395,0.0044978605530961325,0.005696990116159025,0.006372623798132903,0.004930419873420438,0.006520121902550276,0.0040215352633053035,0.0059298899836009574,0.007482399664094512,0.00027522038917083793];

<MultiDataGraph datasets={[ { data: dataset1_grad_nomh, label: "緩和前の経路の勾配のRMS値", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_grad_itr5_nomh, label: "ITR. 5の経路の勾配のRMS値", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_grad_itr10_nomh, label: "ITR. 10の経路の勾配のRMS値", color: "rgba(153, 212, 37, 1)" }, { data: dataset1_grad_itr15_nomh, label: "ITR. 15の経路の勾配のRMS値", color: "rgba(13, 226, 148, 1)" }, { data: dataset2_grad_nomh, label: "緩和後の経路の勾配のRMS値", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="RMS of gradient [hartree/Bohr]" height="500px" />

※`bias_force_rms.csv`にて、各Iterationごとのすべてのノードの勾配のRMS値を確認できる。

緩和後の経路のエネルギー極大値を示すノードの分子構造
`sn2_TfO_F_traj_5.xyz`
```
13
-1 1
C      -1.518212863552     -0.624951600833      1.009912595544
H      -1.289674642173     -1.619897872367      0.693916033805
H      -1.091575720215     -0.213920992966      1.889330544710
H      -2.460328061626     -0.218329695223      0.659838834166
O      -0.623955489214      0.198175266960     -0.173633386275
F      -2.147236570262     -1.804623206232      3.037126405412
S       0.883970047969      0.125016136106     -0.051529909165
O       1.412484219300      0.995407443482      0.952854416990
O       1.389682170676     -1.208693371716     -0.158440340161
C       1.279482572028      0.936547730253     -1.655338139082
F       2.596335520730      1.161240428213     -1.748808394956
F       0.649551329339      2.108319746800     -1.771434572635
F       0.919477487001      0.165709987523     -2.683794088352

```

