---
title:  【計算化学】自作pythonモジュールで遷移状態構造を求めてみる(カルベンの二量化）
published: 2025-07-25
description: ""
tags: [MultiOptPy, python]
category: Computational Chemistry
draft: false
---
最終更新：2025-07-25

import MoleculeViewer from '../../components/MoleculeViewer.astro';
import MultiDataGraph from '../../components/MultiDataGraph.astro';

## 概要

本記事では、自作モジュール(MultiOptPy)で、カルベンの二量化のある１つの素過程の遷移状態構造を算出してみる。電子状態計算ソフトウェアにPySCFを使用する。
MultiOptPyは電子状態計算ソフトウェアを用いた分子構造最適化手法の勉強を目的として作成したpythonモジュールである。


MultiOptPyのレポジトリ:https://github.com/ss0832/MultiOptPy



## 使用した自作モジュールMultiOptPyのバージョン
```
1.9.12c
```
## 環境
```
WSL2 (Ubuntu-22.04)
```
## Source codeのダウンロード

```
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.9.12c.zip
unzip v1.9.12c.zip
cd MultiOptPy-1.9.12c
```


## 手順

### 1. 初期構造の準備

モデル反応系として、以下の構造を用意した。今回は名前を`carbene_dimer.xyz`とした。
初期構造は以下のものを使用した。

```
6

C     -2.033315482724     -0.386881237452      0.330615542003
C      1.902722921613      0.297008852250      0.130298307493
F     -3.337039281709     -0.538210791191      0.489968786138
F     -1.920771464505      0.170613468221     -0.862243427163
F      2.659203648155      1.134262279115     -0.557609516122
F      2.729199659170     -0.676792570943      0.468970307651

```

<MoleculeViewer 
  xyzData={`6

C     -2.033315482724     -0.386881237452      0.330615542003
C      1.902722921613      0.297008852250      0.130298307493
F     -3.337039281709     -0.538210791191      0.489968786138
F     -1.920771464505      0.170613468221     -0.862243427163
F      2.659203648155      1.134262279115     -0.557609516122
F      2.729199659170     -0.676792570943      0.468970307651
`}
  caption="初期パスを求めるための初期構造"
  backgroundColor="#333333"
/>


### 2. 遷移状態構造最適化のための初期構造の算出

※あらかじめpythonで利用できる電子状態計算ソフトウェアのPySCF(導入方法はpipを使えば可能である。)が使える環境を用意しておく。



#### a. 初期構造をカレントディレクトリに`carbene_dimer.xyz`として保存し、以下を実行する。
```
python optmain.py carbene_dimer.xyz -opt rsirfo_fsb -ma 10 1 2 -func hf -bs 3-21g -pyscf -elec 0 -spin 0
```
- `-opt rsirfo_fsb`は準ニュートン法であるRS-I-RFO法を構造最適化に使用することを示す。初期のへシアンに関しては、特にオプションで指定しない限り、単位行列が使われる。
- `-pyscf`は使用する電子状態計算ソフトウェアをPySCFにすることを示す。
- `-spin`はスピン多重度の指定である。PySCFを使用するときは目的とするスピン多重度に1を引いた値を指定する。
- `-elec M`は形式電荷をMとすることを示す。
- `-ma yyy a b `はyyykJ/molの活性化障壁を超えうるペア同士を近づける力を原子のラベル番号aとbのペアに構造最適化時に加えることを示す。
- `-func hf`はHartree-Fock法を用いることを示す。
- `-bs 3-21g`は基底関数にPople系である`3-21G`を用いることを示す。
- `-ns 55`は電子状態計算の反復回数を最大55回までとすることを示す。これは、塩化物イオンが解離したため、計算効率を上げるために指定した


これを実行すると、計算レベル`HF/3-21G`で指定した人工力ポテンシャルをかけた上で初期構造を構造最適化することができる。

結果は`yyyy_mm_dd`（今日の年月日）ディレクトリの中に存在するディレクトリを開いて確認できる。

正常終了していれば、このディレクトリ中に、`carbene_dimer_traj.xyz`が存在するので、これをコピーして、`MultiOptPy-1.9.12c`ディレクトリに置く。

`carbene_dimer_traj.xyz`は構造最適化の過程をAvogadro（公式ページ:https://avogadro.cc/ ）等で可視化して確認できるようにしている。この`carbene_dimer_traj.xyz`は次のNEB計算に使用する。

※`carbene_dimer_traj.xyz`をアニメーションとして表示したい場合は、[https://github.com/ss0832/molecule_movie] を使うと良い。

（この人工力ポテンシャルを加えて行った構造最適化の結果は`carbene_dimer_optimized.xyz`で確認できる。構造を可視化して、生成系になっているか確認する。反応系のままであれば、`-ma`の設定を見直してb.をやり直す。今回の場合以下の構造が得られた。生成系の安定構造に近いものが得られていると判断できるため、次のNEB計算を行うことが可能である。）

<MoleculeViewer 
  xyzData={`6
OptimizedStructure
C     -0.638754961958     -0.051794602170     -0.071856423561
C      0.638771062698      0.051342579777      0.072199437911
F     -1.392027228158     -0.888402481353      0.636678879750
F     -1.338403413822      0.667877649415     -0.945121071106
F      1.391020208068      0.889068450616     -0.636652386088
F      1.339394333171     -0.668091596284      0.944751563094
`}
  caption="初期パスを求めるための構造最適化の結果（安定構造ではない）"
  backgroundColor="#333333"
/>



#### b. `carbene_dimer_traj.xyz`を初期パスとして、NEB法で経路の緩和を行う。

NEB法を用いることで、先ほど得られた`carbene_dimer_traj.xyz`全体のエネルギーを下げることができる。これにより、パスのエネルギー極大値を持つ構造を遷移状態構造に近づける。（この時点ではまだ正確な遷移状態構造は求められていない。）


```
python nebmain.py carbene_dimer_traj.xyz -ns 10 -modelhess -nd 0.15 -func hf -bs 3-21g -pyscf -elec 0 -spin 0 -spng
```
- `-nd N`はノード間の距離をN Åとして初期パスを作成することを示す。
- `-ns n`はn回分NEB法による経路の緩和を行うことを示す。
- `-modelhess`は少ない計算コストで算出された近似へシアンを用いることを示す。これを指定すると経路緩和のアルゴリズムが`-fc`を1以上に指定した場合と同様のものになる。
- `-pyscf`は使用する電子状態計算ソフトウェアをPySCFにすることを示す。
- `-spng`は緩和中のパスのエネルギープロファイルや各ノードの勾配のRMS値をmatplotlibで可視化するオプションである。
- `-spin`はスピン多重度の指定である。PySCFを使用するときは目的とするスピン多重度に1を引いた値を指定する。



#### c. 初期構造の決定及び遷移状態構造の計算

`MultiOptPy-1.9.12c`と同じディレクトリ内に、NEBという名前を含むディレクトリが生成されている。
そのディレクトリ内の`energy_plot.csv`を確認し、緩和後のパスのエネルギー極大値を示す構造を確認する。

パスの緩和後の各ノードのエネルギー一覧(単位:hartree) (energy_plot.csvに保存されている。)

export const dataset1 = [-470.7493174692115,-470.7493174692115,-470.7487694659573,-470.7483482514134,-470.7480141110422,-470.7477100497647,-470.7478455532268,-470.74769964776397,-470.74720573886015,-470.7469235741323,-470.7469580658814,-470.7481072408806,-470.74798653460357,-470.7476719598051,-470.747387416467,-470.74724861143017,-470.74736828836274,-470.74696907872334,-470.7474229422063,-470.74823436002373,-470.7482943321941,-470.7490804742595,-470.7498266186949,-470.7503209807923,-470.75116059829384,-470.7510152682188,-470.75119168445354,-470.7516063591032,-470.75178187158605,-470.7518408784418,-470.75196335284863,-470.75173446117736,-470.7515671690635,-470.75113747433795,-470.750994093537,-470.7509149543392,-470.7498513045802,-470.7502895095106,-470.75059918757415,-470.7501161392041,-470.74832661491075,-470.7501106740633,-470.749792750198,-470.74908312996524,-470.74952376728254,-470.75271724381116,-470.7634512532709,-470.78363365148425,-470.8043157239184,-470.79515868335864,-470.8203160443995,-470.82204399405697,-470.83274070451563,-470.8385573841435,-470.8407084704653,-470.84850184880804,-470.85040087580694,-470.84677738262434,-470.85208687367515,-470.8528946222908,-470.85488706913463];

export const dataset2 = [-470.74950258624915,-470.74941669423686,-470.7494778308885,-470.7494900119732,-470.7494806830017,-470.7494225084165,-470.7493242724514,-470.7491947134753,-470.7490585749455,-470.7487807851834,-470.7493464002844,-470.7495253796133,-470.7501223539301,-470.75003530660763,-470.75023575572175,-470.75033610709306,-470.7504369419322,-470.7500216386592,-470.750023902778,-470.75010527662164,-470.750731627269,-470.7506723531363,-470.7517457890892,-470.75206733235103,-470.7522852467643,-470.75178739085396,-470.7525355537846,-470.7527794219409,-470.75293041147626,-470.75296124219466,-470.7529913643277,-470.7526908110025,-470.7526310631607,-470.75211000006504,-470.7520354032484,-470.75205543178333,-470.7512767211083,-470.7516741041495,-470.7517591473671,-470.75170390906305,-470.7498269626009,-470.7516003970394,-470.7501721533118,-470.760120301234,-470.7721487841078,-470.78795697127305,-470.82231115862044,-470.84099907444846,-470.85169428106076,-470.83962811208585,-470.8522430507916,-470.8501597449355,-470.85277543821974,-470.84933799482474,-470.8518662121211,-470.854056014119,-470.8537899517336,-470.8488314836558,-470.8538949128883,-470.8540166786461,-470.854972258688
];

<MultiDataGraph datasets={[ { data: dataset1, label: "緩和前の経路のエネルギー", color: "rgba(75, 192, 192, 1)" }, { data: dataset2, label: "緩和後の経路のエネルギー", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="Electronic Energy [hartree]" height="500px" />

export const dataset1_grad = [0.00011510195222379334,0.00011510195222379334,0.00460811410833091,0.005889274399872066,0.006643380655675457,0.007079567144771263,0.005646407959296897,0.0041512157938063746,0.00225489897716709,0.003636490795832714,0.008268097958153631,0.003124650016378192,0.004688647682539177,0.0034059746277527877,0.0037013420365969883,0.0037039061125213268,0.003428979296905717,0.005126316381667201,0.0031750593207032726,0.0026935546593000914,0.005847575223577843,0.0038669225514921996,0.00454664590572927,0.005994535145800746,0.003608457366069365,0.0026510405400047054,0.0033608234631190333,0.002332747863351602,0.0018895777210500802,0.0016758987341630803,0.0016946065209032938,0.0029635586340699045,0.002672161306016071,0.004702790306308552,0.005192066847764115,0.003601712392538029,0.009586118167639223,0.0063111078921170615,0.004023656170254482,0.005364369507471133,0.012010786062634261,0.002902866406809253,0.0036233610902807046,0.007175083406765133,0.012774789470683908,0.022667673985006093,0.037052599467559226,0.04896188801539456,0.055906402994796524,0.10309832378768695,0.042984865103032496,0.03394261389261866,0.02519341312922944,0.02301593533133044,0.0266533161616627,0.010306951158448627,0.011510157510418615,0.01779811657717026,0.004405075308255666,0.0034350694673776962,0.0033544763277882274
];

export const dataset2_grad = [0.002571797255891519,0.0014340535114020583,0.0010194336146034466,0.0011928793207603222,0.00207195358154648,0.0017593718957300943,0.0015988280688611007,0.001970892200770681,0.0022868969866086408,0.0037304875871425167,0.0027277224866253703,0.0018539884499131087,0.0024205266800485297,0.0038096335029427822,0.003266815252106271,0.003194894818911113,0.002832763682971875,0.0017665359530902138,0.0016585483005963169,0.0012197392545006175,0.0009959374266135651,0.0010027867820062333,0.0010099401769879239,0.0010266641710955243,0.0007420484418786211,0.0008996300243919555,0.0007021712745019765,0.0006009957378383589,0.0005405849057701045,0.0005496580878668206,0.0004129118514953149,0.0004494682798398543,0.00043553099931872017,0.0004531295660921959,0.00047004426751663105,0.0005973544381213192,0.001148288046093874,0.0008327933640155268,0.0007218921142606069,0.0010208176957904884,0.002025116571979019,0.0008910122114325198,0.0016105541877796243,0.013865886808392151,0.02617315394659406,0.03383048458641779,0.028776033015075333,0.017269785121497846,0.006788065390120177,0.016552844877141697,0.005421754326930277,0.0063640635131526945,0.0032832169343225233,0.00698572116875053,0.004466670864124627,0.001960722225856352,0.0022311528842796666,0.00928941475757639,0.0021041753717266367,0.001951747376027491,0.0004691431710963361];

<MultiDataGraph datasets={[ { data: dataset1_grad, label: "緩和前の経路の勾配のRMS値", color: "rgba(75, 192, 192, 1)" }, { data: dataset2_grad, label: "緩和後の経路の勾配のRMS値", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="RMS of gradient [hartree/Bohr]" height="500px" />

※`bias_force_rms.csv`にて、各Iterationごとのすべてのノードの勾配のRMS値を確認できる。

私が実行した環境では、40番のノード(グラフでは41番)がエネルギー極大値を示していた。


※こちら[https://ss0832.github.io/molecule_viewer/] を使うことでも可視化は可能である。


`carbene_dimer_traj_40.xyz`
```
6
0 0
C      -1.111142667024      0.281509166054      0.115884920527
C       1.071045660424     -0.117199939487     -0.212744612589
F      -1.604443973462     -0.825074941336      0.653199873039
F      -1.661295211252      0.352099702725     -1.083389898999
F       1.727869362586      1.019685157062     -0.325620783345
F       1.577966828728     -0.711019145018      0.852670501367

```


<MoleculeViewer 
  xyzData={`6
0 0
C      -1.111142667024      0.281509166054      0.115884920527
C       1.071045660424     -0.117199939487     -0.212744612589
F      -1.604443973462     -0.825074941336      0.653199873039
F      -1.661295211252      0.352099702725     -1.083389898999
F       1.727869362586      1.019685157062     -0.325620783345
F       1.577966828728     -0.711019145018      0.852670501367
`}
  caption="NEB法により緩和したパスのエネルギー極大値を示す構造"
  backgroundColor="#333333"
/>


構造が壊れていないので、これを遷移状態を求めるための初期構造とする。

`carbene_dimer_traj_40.xyz`を`MultiOptPy-1.9.12c`と同じディレクトリ内にコピーする。

そして、以下を実行する。

```
python optmain.py carbene_dimer_traj_40.xyz -opt rsirfo_bofill -fc 5 -order 1 -func hf -bs 3-21g -pyscf -elec 0 -spin 0 -tcc -freq
```
- `-opt rsirfo_bofill`は遷移状態構造の最適化向けのoptimizerを指定することを意味する。準ニュートン法であるRS-I-RFO法を使用する。今回は`-fc`で正確なへシアンを計算するようにしているので、初期へシアンは正確なへシアンを使用するようになっている。
- `-order 1`は一次の鞍点を求めることを指定する。（デフォルトだと極小値を求めるようになっている。）
- `-fc 5`は5回の反復回数当たり1回正確なへシアンを計算することを指定する。
- `-freq`は収束条件を満たした後に基準振動解析を行うことを示す。（自前で実装しているため、あくまで目安として使用することを推奨する。各振動モードを`vibration_animation`内のxyzファイルで可視化できる。）
- `-tcc`は収束条件を厳しくすることを示す。（Gaussianのtightと同等）

実行して得られた正確な遷移状態構造を以下に示す。


(実行して得られた正確な遷移状態構造は`carbene_dimer_traj_17_optimized.xyz`として保存されている。)

```
6
OptimizedStructure
C     -1.004787000959      0.184361766239      0.154875559964
C      1.004786699700     -0.184378335515     -0.154859263090
F     -1.613004535323     -0.933062634307      0.509133195433
F     -1.570073814661      0.552112632352     -0.980587404299
F      1.612973611199      0.933048367486     -0.509164740019
F      1.570105040044     -0.552081796256      0.980602652012

```

<MoleculeViewer 
  xyzData={`6
OptimizedStructure
C     -1.004787000959      0.184361766239      0.154875559964
C      1.004786699700     -0.184378335515     -0.154859263090
F     -1.613004535323     -0.933062634307      0.509133195433
F     -1.570073814661      0.552112632352     -0.980587404299
F      1.612973611199      0.933048367486     -0.509164740019
F      1.570105040044     -0.552081796256      0.980602652012
`}
  caption="遷移状態構造"
  backgroundColor="#333333"
/>



160回程度の反復計算で遷移状態構造が得られた。`-freq`オプションにより生成された`normal_modes.txt`や`vibration_animation`ディレクトリ内の振動モードのアニメーションを確認した。

以下に`-freq`オプションで生成された`normal_modes.txt`の一部を示す。
```
Mode                                 0                   1                   2
Freq [cm^-1]                     -214.6615             80.7760            116.6937
Reduced mass [au]                  14.5098             18.0024             18.9970
Force const [Dyne/A]               -0.3939              0.0692              0.1524
Char temp [K]                       0.0000            116.2186            167.8962
Normal mode                   x         y         z            x         y         z            x         y         z   
       C                -0.14011    0.03716    0.03301   -0.00128   -0.04438    0.04452   -0.00005   -0.00163    0.00164
       C                 0.14011   -0.03716   -0.03301   -0.00128   -0.04438    0.04452   -0.00005   -0.00163    0.00164
       F                -0.07628   -0.00764   -0.01739   -0.07667   -0.03774   -0.06788   -0.07936    0.06029    0.05679
       F                -0.07649   -0.01521   -0.00979    0.07748    0.06577    0.03976    0.07939   -0.05926   -0.05782
       F                 0.07628    0.00764    0.01738   -0.07667   -0.03775   -0.06788   -0.07936    0.06029    0.05679
       F                 0.07650    0.01521    0.00980    0.07748    0.06578    0.03976    0.07939   -0.05926   -0.05782

(...snip...)
```
その結果、虚振動が１つであることが確認できた。

次に、`vibration_animation`内の`mode_1_215i_wave_number.xyz`をAvogadroで確認すると、想定される反応系と生成系をつなぐ方向に振動していることを確認できた。


## 終わりに
　
　自作モジュールで、電子状態計算モジュールであるPySCFを用いて、計算レベル`HF/3-21G`でカルベンの二量化の１つの素過程の遷移状態構造を算出する手順を説明した。


## 参考
- https://github.com/pyscf/pyscf (PySCFのgithubのレポジトリ)
- https://github.com/ss0832/MultiOptPy (自作モジュールMultiOptPyのレポジトリ)
- https://avogadro.cc/ (Avogadro、分子構造可視化ツール)
- _The Journal of Chemical Physics_ 2010, 132, 241102.
- _The Journal of Chemical Physics_ 1991, 94, 751–760.
- In _Classical and Quantum Dynamics in Condensed Phase Simulations_; WORLD SCIENTIFIC: LERICI, Villa Marigola, 1998; pp 385–404.
- _The Journal of Chemical Physics_, 2020, 153, 024109.
- _The Journal of Chemical Physics_, 2022, 144, 214108.
