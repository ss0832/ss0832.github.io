---
title:  【計算化学】自作pythonモジュールで遷移状態構造を求めてみる(SN2反応（基質-fluoromethane, 求核剤-bromide ion）, NNP使用）
published: 2025-08-14
description: ""
tags: [MultiOptPy, python]
category: Computational Chemistry
draft: false
---
最終更新：2025-08-14

import MoleculeViewer from '../../components/MoleculeViewer.astro';
import MultiDataGraph from '../../components/MultiDataGraph.astro';

## 概要

本記事では、自作モジュール(MultiOptPy)で、SN2反応（基質-fluoromethane, 求核剤-bromide ion）の遷移状態構造を算出してみる。使用する計算レベルは、Meta社のFAIR Chemistryが開発したニューラルネットワークポテンシャル(NNP)であるUMA(Meta’s Universal Model for Atoms)を使用する。

MultiOptPyは電子状態計算ソフトウェアを用いた分子構造最適化手法の勉強を目的として作成したpythonモジュールである。

MultiOptPyのレポジトリ:https://github.com/ss0832/MultiOptPy

SN2反応について：
- https://en.wikipedia.org/wiki/SN2_reaction

今回使用したニューラルネットワークポテンシャルについて：
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)



## 使用した自作モジュールMultiOptPyのバージョン
```
v1.12b
```
## 環境
```
Windows 11
```
※Windows 11環境下でAnaconda PowerShell Promptを使用した。

## Source codeのダウンロード
```
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.12b.zip
unzip v1.12b.zip
cd MultiOptPy-v1.12b
```

### 環境構築手順

今回は、Windows 11のPower Shellを使用した。初めに、NNPを使用できる環境が整ったAnaconda PowerShell Promptを用意する手順を説明する。

1, https://repo.anaconda.com/archive/ より、`Anaconda3-2025.06-1-Windows-x86_64.exe`でAnacondaをインストールする。

2, 検索機能を使い、スタートから`Anaconda PowerShell Prompt`を開く。

3, 以下のコマンドを実行し、仮想環境を作成する。
```
conda create -n (任意の仮想環境名) python=3.12.7
```

4, 先ほど作成した仮想環境を`conda activate (仮想環境名)`で起動させる。

5, 以下のコマンドを実行し、必要なライブラリを導入する。
```
pip install fairchem-core==2.2.0 ase==3.25.0 torch==2.6.0
```
- fairchem-coreは、FAIR Chemistryが管理しているNNPを動作させるために必要なライブラリである。
- aseはNNPに電子エネルギーを算出したい分子構造を渡すために必要なインターフェイスの役割を果たすために必要なライブラリである。
- torchはPyTorchライブラリを指す。これはニューラルネットワークなどの機械学習を行ったり、学習結果を扱ったりするために必須なライブラリである。

これで、`Anaconda PowerShell Prompt`から仮想環境を立ち上げることで、NNPを使用する準備が整えることが出来る。

次に、NNPを使用するために必要なModelの情報が保存されている`.pt`ファイルのダウンロードおよびNNPの自作モジュールへの導入方法について説明する。


1, 以下のサイトにアクセスして、`uma-s-1p1.pt`をダウンロードする。（使用許諾が下りていれば可能である。）
```
https://huggingface.co/facebook/UMA
```

2, ダウンロード後、`MultiOptPy-v1.12b`ディレクトリ内に存在する`software_path.conf`に対して、`uma-s-1p1.pt`の絶対パスを用いて以下を追記する。
```
uma-s-1p1::(uma-s-1p1.ptの絶対パス)
```

これで、`MultiOptPy-v1.12b`がNNP`uma-s-1p1`を使用できるようになる。


### 使用するNNPに関する具体的な説明

今回使用するNNPについて具体的に説明する。

- UMAのModel Checkpointは`uma-s-1p1`を使用した。

:::important

モデルをダウンロードした時点(2025/8/9)で、`uma-s-1`のモデルが存在していたが、https://huggingface.co/facebook/UMA より、

” *Note uma-s-1 is now deprecated and will be removed by the next release. uma-s-1p1 should be used instead for a replacement.

とあり、今後のアップデートで削除されるため、使用しなかった。

:::

- 小分子系のトレーニングセットである`Omol25`(`omol`)を使用して学習したニューラルネットワークポテンシャルを使用する。



※自作モジュールでの具体的な使用の仕方に関しては、https://github.com/ss0832/MultiOptPy/blob/main/multioptpy/ase_calculation_tools.py を参照



## 手順

### 1. 初期構造の準備

モデル反応系として、以下の構造を用意した。今回はファイルの名前を`sn2_F_Br.xyz`とした。
初期構造は以下のものを使用した。

```
6

C      0.155736205821      0.286174521672     -0.478855986633
H      0.517288234697     -0.741491478171     -0.484294110940
H      0.518489436417      0.808965075594      0.405410750902
H     -0.933433059578      0.296959128840     -0.495001016718
F      0.629802700910      0.934425368047     -1.609579005631
Br    -0.887883518267     -1.585032615981      2.662319369020

```

<MoleculeViewer 
  xyzData={`6

C      0.155736205821      0.286174521672     -0.478855986633
H      0.517288234697     -0.741491478171     -0.484294110940
H      0.518489436417      0.808965075594      0.405410750902
H     -0.933433059578      0.296959128840     -0.495001016718
F      0.629802700910      0.934425368047     -1.609579005631
Br    -0.887883518267     -1.585032615981      2.662319369020
`}
  caption="初期パスを求めるための初期構造"
  backgroundColor="#333333"
/>


### 2. 遷移状態構造最適化のための初期構造の算出


#### a. 初期構造をカレントディレクトリに`sn2_F_Br.xyz`として保存し、以下を実行する。
```
python .\optmain.py sn2_F_Br.xyz -opt rsirfo_fsb -os uma-s-1p1 -ma 300 1 6 -elec -1
```
- `-opt rsirfo_fsb`は準ニュートン法であるRS-I-RFO法を構造最適化に使用することを示す。初期のへシアンに関しては、特にオプションで指定しない限り、単位行列が使われる。
- `-spin`はスピン多重度の指定である。PySCFを使用するときは目的とするスピン多重度に1を引いた値を指定する。（デフォルトでは1が指定される。）
- `-elec M`は形式電荷をMとすることを示す。（デフォルトでは0が指定される。）
- `-ma yyy a b `はyyykJ/molの活性化障壁を超えうるペア同士を近づける力を原子のラベル番号aとbのペアに構造最適化時に加えることを示す。
- `-os uma-s-1p1`は今回使用するNNPを指定している。これを使用する際にASEライブラリが必要である。

これを実行すると、`omol`のデータセットを使用した`uma-s-1p1`モデルのNNPで得たエネルギーに対して、指定した人工力ポテンシャルを加えた上で初期構造を構造最適化することができる。

結果は`yyyy_mm_dd`（今日の年月日）ディレクトリの中に存在するディレクトリを開いて確認できる。

正常終了していれば、このディレクトリ中に、`sn2_F_Br_traj.xyz`が存在するので、これをコピーして、`MultiOptPy-v1.12b`ディレクトリに置く。

`sn2_F_Br_traj.xyz`は構造最適化の過程をAvogadro（公式ページ:https://avogadro.cc/ ）等で可視化して確認できるようにしている。この`sn2_F_Br_traj.xyz`は次のNEB計算に使用する。

※`sn2_F_Br_traj.xyz`をアニメーションとして表示したい場合は、[https://github.com/ss0832/molecule_movie] を使うと良い。

（この人工力ポテンシャルを加えて行った構造最適化の結果は`sn2_F_Br_optimized.xyz`で確認できる。構造を可視化して、生成系になっているか確認する。反応系のままであれば、`-ma`の設定を見直してb.をやり直す。今回の場合以下の構造が得られた。生成系の安定構造に近いものが得られていると判断できるため、次のNEB計算を行うことが可能である。）

```
6
OptimizedStructure
C     -0.109147258947     -0.158744342004      0.274108504215
H      0.491299353414     -0.796459825828     -0.361110710898
H      0.487111217621      0.709190966142      0.523252527933
H     -0.958122941655      0.179268862701     -0.305924953470
F      0.739760827347      1.111627764924     -1.910940060079
Br    -0.650901197779     -1.044883425935      1.780614692298

```

<MoleculeViewer 
  xyzData={`6
OptimizedStructure
C     -0.109147258947     -0.158744342004      0.274108504215
H      0.491299353414     -0.796459825828     -0.361110710898
H      0.487111217621      0.709190966142      0.523252527933
H     -0.958122941655      0.179268862701     -0.305924953470
F      0.739760827347      1.111627764924     -1.910940060079
Br    -0.650901197779     -1.044883425935      1.780614692298
`}
  caption="初期パスを求めるための構造最適化の結果（安定構造ではない）"
  backgroundColor="#333333"
/>



#### b. `sn2_F_Br_traj.xyz`を初期パスとして、NEB法で経路の緩和を行う。

NEB法を用いることで、先ほど得られた`sn2_F_Br_traj.xyz`全体のエネルギーを下げることができる。これにより、パスのエネルギー極大値を持つ構造を遷移状態構造に近づける。（この時点ではまだ正確な遷移状態構造は求められていない。）


```
python .\nebmain.py sn2_F_Br_traj.xyz -os uma-s-1p1 -ns 10 -modelhess -spng -nd 0.15 -elec -1
```
- `-nd N`はノード間の距離をN Åとして初期パスを作成することを示す。
- `-ns n`はn回分NEB法による経路の緩和を行うことを示す。
- `-fc M`はM回あたりの経路緩和回数に対して1回だけ正確なHessianを計算し、経路緩和に使用する。これを使用すると、Hessianを使用しない場合の経路緩和アルゴリズムとは別のものを使用して、経路緩和を行う。
- `-spng`は緩和中のパスのエネルギープロファイルや各ノードの勾配のRMS値をmatplotlibで可視化するオプションである。
- `-os uma-s-1p1`は今回使用するNNPを指定している。これを使用する際にASEライブラリが必要である。



#### c. 初期構造の決定及び遷移状態構造の計算

`MultiOptPy-v1.12b`と同じディレクトリ内に、NEBという名前を含むディレクトリが生成されている。
そのディレクトリ内の`energy_plot.csv`を確認し、緩和後のパスのエネルギー極大値を示す構造を確認する。

パスの緩和後の各ノードのエネルギー一覧(単位:hartree) (energy_plot.csvに保存されている。)

export const dataset1 = [-2713.8532980892232,-2713.8532980892232,-2713.850872644163,-2713.8454795526472,-2713.84083976736,-2713.8360179223346,-2713.830610426555,-2713.8242118139974,-2713.81541004619,-2713.802803962334,-2713.790306510639,-2713.7804124632576,-2713.771766991357,-2713.759100896304,-2713.7788618516443,-2713.7908045924023,-2713.793837281471];

export const dataset_itr2 = [-2713.85441333326,-2713.853479912395,-2713.8518071251956,-2713.850068029314,-2713.847440477705,-2713.843721478885,-2713.83868859912,-2713.8321980498554,-2713.8229750361706,-2713.8097149207324,-2713.7958846014485,-2713.7861009122867,-2713.783399635201,-2713.7742840598926,-2713.7848488759278,-2713.7933987136767,-2713.799947046471];

export const dataset_itr4 = [-2713.8548284897433,-2713.853792092407,-2713.85272432812,-2713.8523706175647,-2713.8519310509346,-2713.8495479512576,-2713.8454595671687,-2713.8395166866108,-2713.830642450634,-2713.817096116154,-2713.800074087001,-2713.79176388662,-2713.7907142678514,-2713.783734473016,-2713.7880840263947,-2713.7953145027436,-2713.800523909222];

export const dataset_itr6 = [-2713.8548451983397,-2713.854066929977,-2713.85336840201,-2713.8533612962565,-2713.8539431181403,-2713.8529377460472,-2713.8500557541474,-2713.845201998945,-2713.8374878144305,-2713.8245523556907,-2713.8028595948626,-2713.7955270664033,-2713.794299965894,-2713.7891062472713,-2713.7903314596306,-2713.796797362182,-2713.8008851198083];

export const dataset_itr8 = [-2713.854848948355,-2713.854307807128,-2713.853727597401,-2713.853821768346,-2713.8541966034036,-2713.8543434760822,-2713.852482750032,-2713.848862749863,-2713.8426477128214,-2713.8315117707702,-2713.804502745551,-2713.7977166328724,-2713.796604494865,-2713.794357718758,-2713.7935712406656,-2713.798887378012,-2713.801138653261];

export const dataset2 = [-2713.854814681276,-2713.854414656279,-2713.853795509477,-2713.853957758971,-2713.854563360157,-2713.854424206552,-2713.8531526008956,-2713.8500610287015,-2713.8445214763083,-2713.8346806388404,-2713.804944730415,-2713.798446032753,-2713.797952656032,-2713.79623579301,-2713.79533258693,-2713.7996453849014,-2713.8012808778485];

<MultiDataGraph datasets={[ { data: dataset1, label: "緩和前の経路のエネルギー", color: "rgba(75, 192, 192, 1)" }, { data: dataset_itr2, label: "ITR. 2の経路のエネルギー", color: "rgba(75, 100, 192, 1)" }, { data: dataset_itr4, label: "ITR. 4の経路のエネルギー", color: "rgba(0, 100, 100, 1)" }, { data: dataset_itr6, label: "ITR. 6の経路のエネルギー", color: "rgba(100, 50, 150, 1)" }, { data: dataset_itr8, label: "ITR. 8の経路のエネルギー", color: "rgba(150, 50, 100, 1)" }, { data: dataset2, label: "緩和後の経路のエネルギー", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="Electronic Energy [hartree]" height="500px" />

export const dataset1_grad = [0.004629525921717516,0.0046295264337971685,0.012677977833441875,0.018417741921616427,0.019922407314487245,0.020217378714828718,0.0197453543511712,0.018567208877419267,0.017091181128945632,0.016405008963630244,0.017872434871031025,0.019765479039925538,0.02880165872954605,0.047081590227264256,0.0298433165477849,0.019639374215999473,0.019152677257295372];

export const dataset1_grad_itr2 = [0.0027973930419383764,0.004230860885003208,0.011124867512931139,0.012724634585011815,0.015287919279275359,0.0168841533843561,0.01763965510103372,0.01774587933154918,0.017446097314826953,0.016886300594640843,0.014629826661279972,0.016146805643977077,0.020924666188672524,0.0352047967814865,0.025273652162443157,0.017580248169315894,0.008024349040230203];

export const dataset1_grad_itr4 = [0.001512548821996718,0.0036797797058678154,0.009301869982427411,0.0094266791586748,0.008803972782063381,0.011312178498658232,0.013522343257278323,0.015145231468753382,0.01650914002639324,0.017503958956114424,0.012014014247962359,0.012056326381856653,0.015379160869565499,0.027417877971648172,0.023073047868146377,0.015858565794809727,0.006666098770771406];

export const dataset1_grad_itr6 = [0.0006978227538135801,0.003261682991616221,0.007741108790727307,0.007716206985755734,0.004471778419075634,0.0058995010842797695,0.007892562689770719,0.010675897607633255,0.013677143853530485,0.017065171555824335,0.010128841712631141,0.00886672028006611,0.012484818223858905,0.02242949519143365,0.020915422873697107,0.013932438476582916,0.005745072805676871];

export const dataset1_grad_itr8 = [0.0004571021663372485,0.002915443727122973,0.006669705297839844,0.005822481406898918,0.004220953079893916,0.0020180044493168627,0.004124605553422388,0.0063231870171321656,0.00972227727709419,0.015225581096592673,0.008881153527764724,0.006720094886659898,0.010470283210102353,0.01607683876471274,0.017236182851401195,0.010214351104429018,0.005049287779004622];

export const dataset2_grad = [0.0002907684999306368,0.00275604745570661,0.006472325110905118,0.0051075710631004086,0.0030771761021698815,0.0030544412303819633,0.0029546266834695237,0.005037802890669834,0.008198643527553146,0.013826298796813019,0.008469731634823742,0.005952204123307189,0.008999493183129084,0.013595170330907937,0.015168107036589364,0.00867981332878617,0.004115960103317704];

<MultiDataGraph datasets={[ { data: dataset1_grad, label: "緩和前の経路の勾配のRMS値", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_grad_itr2, label: "ITR. 2の経路の勾配のRMS値", color: "rgba(75, 100, 192, 1)" }, { data: dataset1_grad_itr4, label: "ITR. 4の経路の勾配のRMS値", color: "rgba(0, 100, 100, 1)" }, { data: dataset1_grad_itr6, label: "ITR. 6の経路の勾配のRMS値", color: "rgba(100, 50, 150, 1)" }, { data: dataset1_grad_itr8, label: "ITR. 8の経路の勾配のRMS値", color: "rgba(150, 50, 100, 1)" }, { data: dataset2_grad, label: "緩和後の経路の勾配のRMS値", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="RMS of gradient [hartree/Bohr]" height="500px" />

※`bias_force_rms.csv`にて、各Iterationごとのすべてのノードの勾配のRMS値を確認できる。

今回は、構造を目視でWalden反転の図解のような分子構造の部位が平面になっているノードを遷移状態構造を求める初期構造(10番(グラフでは11番))として採用した。

※こちら[https://ss0832.github.io/molecule_viewer/] を使うことでも可視化は可能である。


`sn2_F_Br_traj_10.xyz`
```
6
-1 1
C       0.008136582554      0.027646371450     -0.044701162151
H       0.522416661692     -0.844457105380     -0.399908915347
H       0.519259986148      0.773586644507      0.535502721230
H      -0.998216036130      0.221717234682     -0.375892897223
F       0.624430909580      0.918355127468     -1.586745766651
Br     -0.676028103844     -1.096848272727      1.871746020142

```


<MoleculeViewer 
  xyzData={`6
-1 1
C       0.008136582554      0.027646371450     -0.044701162151
H       0.522416661692     -0.844457105380     -0.399908915347
H       0.519259986148      0.773586644507      0.535502721230
H      -0.998216036130      0.221717234682     -0.375892897223
F       0.624430909580      0.918355127468     -1.586745766651
Br     -0.676028103844     -1.096848272727      1.871746020142
`}
  caption="NEB法により緩和したパスのエネルギー極大値を示す構造"
  backgroundColor="#333333"
/>


構造が壊れていないので、これを遷移状態を求めるための初期構造とする。

`sn2_F_Br_traj_10.xyz`を`MultiOptPy-v1.12b`と同じディレクトリ内にコピーする。

そして、以下を実行する。

```
python .\optmain.py sn2_F_Br_traj_10.xyz -freq -tcc -opt rsirfo_bofill -fc 5 -order 1 -os uma-s-1p1
```
- `-opt rsirfo_bofill`は遷移状態構造の最適化向けのoptimizerを指定することを意味する。準ニュートン法であるRS-I-RFO法を使用する。今回は`-fc`で正確なへシアンを計算するようにしているので、初期へシアンは正確なへシアンを使用するようになっている。
- `-order 1`は一次の鞍点を求めることを指定する。（デフォルトだと極小値を求めるようになっている。）
- `-fc 5`は5回の反復回数当たり1回正確なへシアンを計算することを指定する。
- `-freq`は収束条件を満たした後に基準振動解析を行うことを示す。（自前で実装しているため、あくまで目安として使用することを推奨する。各振動モードを`vibration_animation`内のxyzファイルで可視化できる。）UMAモデルから算出されるHessianは数値微分により求めているため、原子数Zが多いとZの二乗オーダーで計算コストが急増する。
- `-tcc`は収束条件を厳しくすることを示す。（Gaussianのtightと同等）

実行して得られた正確な遷移状態構造を以下に示す。


(実行して得られた正確な遷移状態構造は`sn2_F_Br_traj_10_optimized.xyz`として保存されている。)

```
6
OptimizedStructure
C     -0.023701688495     -0.036592434458      0.062840742983
H      0.534041117734     -0.827411488705     -0.397561286654
H      0.531230117089      0.756088202538      0.523435317981
H     -0.975652937395      0.209585678575     -0.363326580989
F      0.636457973129      0.982344573133     -1.687022246417
Br    -0.702374582062     -1.084014531083      1.861634053095

```

<MoleculeViewer 
  xyzData={`6
OptimizedStructure
C     -0.023701688495     -0.036592434458      0.062840742983
H      0.534041117734     -0.827411488705     -0.397561286654
H      0.531230117089      0.756088202538      0.523435317981
H     -0.975652937395      0.209585678575     -0.363326580989
F      0.636457973129      0.982344573133     -1.687022246417
Br    -0.702374582062     -1.084014531083      1.861634053095
`}
  caption="遷移状態構造"
  backgroundColor="#333333"
/>



10回程度の反復計算で遷移状態構造が得られた。`-freq`オプションにより生成された`normal_modes.txt`や`vibration_animation`ディレクトリ内の振動モードのアニメーションを確認した。

以下に`-freq`オプションで生成された`normal_modes.txt`の一部を示す。
```
Mode                                 0                   1                   2
Freq [cm^-1]                     -353.8865            204.8469            204.8563
Reduced mass [au]                  12.4211              4.1486              4.1487
Force const [Dyne/A]               -0.9165              0.1026              0.1026
Char temp [K]                       0.0000            294.7290            294.7424
Normal mode                   x         y         z            x         y         z            x         y         z     
       C                -0.08018   -0.12376    0.21252   -0.16498    0.15237    0.02649   -0.13786   -0.12733   -0.12617
       H                -0.02162    0.02030    0.02421   -0.15702    0.19183   -0.02040   -0.15339   -0.14661   -0.11594
       H                -0.02153   -0.03115   -0.00571   -0.17848    0.15701    0.03686   -0.12813   -0.10579   -0.18672
       H                 0.02744   -0.01340    0.02309   -0.19176    0.13892    0.06865   -0.15993   -0.15438   -0.10081
       F                 0.02924    0.04514   -0.07751    0.06904   -0.06377   -0.01109    0.05770    0.05329    0.05278
      Br                 0.00535    0.00826   -0.01419    0.01520   -0.01405   -0.00244    0.01271    0.01173    0.01163

(...snip...)
```
その結果、虚振動が１つであることが確認できた。

次に、`vibration_animation`内の`mode_1_354i_wave_number.xyz`をAvogadroで確認すると、想定される反応系と生成系をつなぐ方向に振動していることを確認できた。



## 終わりに
　
　自作モジュールで、UMAモデルのニューラルネットワークポテンシャル(NNP)を用いて、SN2反応（基質-fluoromethane, 求核剤-bromide ion）のある1つの遷移状態構造を算出する手順を説明した。


## 参考
- https://github.com/ss0832/MultiOptPy (自作モジュールMultiOptPyのレポジトリ)
- https://avogadro.cc/ (Avogadro、分子構造可視化ツール)
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)
- _The Journal of Chemical Physics_ 2010, 132, 241102.
- _The Journal of Chemical Physics_ 1991, 94, 751–760.
- In _Classical and Quantum Dynamics in Condensed Phase Simulations_; WORLD SCIENTIFIC: LERICI, Villa Marigola, 1998; pp 385–404.
- _The Journal of Chemical Physics_, 2020, 153, 024109.
- _The Journal of Chemical Physics_, 2022, 144, 214108.
