---
title:  【計算化学】自作pythonライブラリで遷移状態構造を求めてみる(BH9データセットの8. Nucleophilic substitution, No. 1の化学反応, NNP(UMA)使用)
published: 2025-12-21
description: ""
tags: [MultiOptPy, python]
category: Computational Chemistry
draft: false
---
最終更新：2025-12-21

import MoleculeViewer from '../../components/MoleculeViewer.astro';
import MultiDataGraph from '../../components/MultiDataGraph.astro';

## 概要

本記事では、自作ライブラリ(MultiOptPy)で、BH9データセットの8. Nucleophilic substitution, No. 1の化学反応の素過程の遷移状態構造を算出してみる。計算レベルは、Meta社のFAIR Chemistryが開発したニューラルネットワークポテンシャル(NNP)であるUMA(Meta’s Universal Model for Atoms)とした。

MultiOptPyは電子状態計算ソフトウェアを用いた分子構造最適化手法の勉強を目的として作成したpythonライブラリである。

MultiOptPyのレポジトリ:https://github.com/ss0832/MultiOptPy


今回使用したニューラルネットワークポテンシャルについて：
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)
- arXiv preprint arXiv:2505.08762 (2025). (プレプリント)

BH9のデータセットについて:

- _J. Chem. Theory Comput._ 2022, 18, 1, 151–166 

https://doi.org/10.1021/acs.jctc.1c00694


この文献のSupporting Informationから、データセットの詳細を確認できる。

有機金属錯体が関わる反応を除いたさまざまなカテゴリの反応がまとめられたデータセットである。DFTの汎関数の電子エネルギーの精度の比較などのベンチマークに主に使われることを想定していると考えられる。


## 使用した自作ライブラリMultiOptPyのバージョン
```
v1.20.4
```
## Video Demo

https://www.youtube.com/watch?v=AE61iY2HZ8Y


## 環境
```
Windows 11
```
※Windows 11環境下でAnaconda PowerShell Promptを使用した。

## Source codeのダウンロード(Unixコマンド)
```
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.20.4.zip
unzip v1.20.4.zip
cd MultiOptPy-1.20.4
```
https://github.com/ss0832/MultiOptPy/releases/tag/v1.20.4 にアクセスしてzipファイルをダウンロードする。Unixコマンドの場合とはディレクトリ名が異なるので都度読み替えていただけると良い。

移動先のディレクトリで`requirements.txt`を参照することで、本ソースコードで必要なモジュールを把握することが出来る。導入方法は各自の状況に合わせて適宜LLMとの対話などで調べると良い。

次に述べる環境構築手順を使用する場合は、環境構築が終わった後、`pip install -r requirements.txt`で本自作モジュールが動作させるために最低限必要なモジュールを導入することが可能である。

### 環境構築手順

今回は、Windows 11のPower Shellを使用した。初めに、NNPを使用できる環境が整ったAnaconda PowerShell Promptを用意する手順を説明する。

1, https://repo.anaconda.com/archive/ より、`Anaconda3-2025.06-1-Windows-x86_64.exe`でAnacondaをインストールする。

2, 検索機能を使い、スタートから`Anaconda PowerShell Prompt`を開く。

3, 以下のコマンドを実行し、仮想環境を作成する。
```
conda create -n (任意の仮想環境名) python=3.12.7
```

4, 先ほど作成した仮想環境を`conda activate (仮想環境名)`で起動させる。

5, 以下のコマンドを実行し、必要なライブラリを導入する。
```
pip install ase==3.26.0 fairchem-core==2.7.1 torch==2.6.0
```
- fairchem-coreは、FAIR Chemistryが管理しているNNPを動作させるために必要なライブラリである。
- aseはNNPに電子エネルギーを算出したい分子構造を渡すために必要なインターフェイスの役割を果たすために必要なライブラリである。
- torchはPyTorchライブラリを指す。これはニューラルネットワークなどの機械学習を行ったり、学習結果を扱ったりするために必須なライブラリである。

これで、`Anaconda PowerShell Prompt`から仮想環境を立ち上げることで、NNPを使用する準備が整えることが出来る。

次に、NNPを使用するために必要なModelの情報が保存されている`.pt`ファイルのダウンロードおよびNNPの自作ライブラリへの導入方法について説明する。

#### UMAを使用可能にするための手順

1, 以下のサイトにアクセスして、`uma-s-1p1.pt`をダウンロードする。（使用許諾が下りていれば可能である。）
```
https://huggingface.co/facebook/UMA
```

2, ダウンロード後、`MultiOptPy-1.20.4`ディレクトリ内に存在する`software_path.conf`に対して、`uma-s-1p1.pt`の絶対パスを用いて以下を追記する。
```
uma-s-1p1::(uma-s-1p1.ptの絶対パス)
```

これで、`MultiOptPy-1.20.4`がNNP`uma-s-1p1`を使用できるようになる。

#### ※Linuxの場合

すでにAnacondaの導入が終わっている前提で、環境の構築手段について述べる。以下を実行すると可能である。

```
## 1. Download and install MultiOptPy:
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.20.4.zip
unzip v1.20.4.zip
cd MultiOptPy-1.20.4

## 2. Create and activate a conda environment:
conda env create -f environment.yml
conda activate test_mop

## 3. Copy the test configuration file and run the AutoTS workflow（任意で行う）:
cp test/config_autots_run_xtb_test.json .
python run_autots.py aldol_rxn.xyz -cfg config_autots_run_xtb_test.json


#### Installation via pip (Linux)
conda create -n <env-name> python=3.12 pip
conda activate <env-name>
pip install git+https://github.com/ss0832/MultiOptPy.git@v1.20.4 
# or pip install multioptpy
wget https://github.com/ss0832/MultiOptPy/archive/refs/tags/v1.20.4.zip
unzip v1.20.4.zip
cd MultiOptPy-1.20.4

```

あとは、「UMAを使用可能にするための手順」と同じように進めれば問題なく導入可能である。


### 使用するNNPに関する具体的な説明

今回使用するNNPについて具体的に説明する。

- UMAのModel Checkpointは`uma-s-1p1`を使用した。
- 小分子系のトレーニングセットである`Omol25`(`omol`)を使用して学習したニューラルネットワークポテンシャルを使用する。

※自作ライブラリでの具体的な使用の仕方に関しては、`ase_calculation_tools.py` を参照すると良い。`omol`以外のモデルを使用したい場合は、現バージョンでは、`multioptpy/Calculator/ase_tools/firechem.py`内の、`self.task_name`を編集することで対応可能である。


## 手順

### 1. 初期構造の準備

モデル反応系として、以下の構造を用意した。今回はファイルの名前を`bh9_8_1.xyz`とした。
初期構造は以下のものを使用した。

```
12
OptimizedStructure
C     -0.829407992084      0.389833239234      0.002683318140
O     -0.669021789807      1.590013279682      0.004832385229
C     -2.193958341073     -0.264353706197     -0.000611297450
H     -2.297317639936     -0.904890199976      0.875191692257
H     -2.296628591672     -0.895829413283     -0.883071188033
H     -2.965037890790      0.500987025155      0.002765265475
O      0.128931352591     -0.514127789050      0.003161776554
C      1.526426467735     -0.031946293678     -0.000479415431
H      2.171418420140     -0.896880671420      0.005428615180
H      1.697535233346      0.557738102563     -0.893457380570
H      1.698511713925      0.570929749119      0.883662983341
F      4.028549057626     -0.101473322149     -0.000106754691
```

<MoleculeViewer 
  xyzData={`12
OptimizedStructure
C     -0.829407992084      0.389833239234      0.002683318140
O     -0.669021789807      1.590013279682      0.004832385229
C     -2.193958341073     -0.264353706197     -0.000611297450
H     -2.297317639936     -0.904890199976      0.875191692257
H     -2.296628591672     -0.895829413283     -0.883071188033
H     -2.965037890790      0.500987025155      0.002765265475
O      0.128931352591     -0.514127789050      0.003161776554
C      1.526426467735     -0.031946293678     -0.000479415431
H      2.171418420140     -0.896880671420      0.005428615180
H      1.697535233346      0.557738102563     -0.893457380570
H      1.698511713925      0.570929749119      0.883662983341
F      4.028549057626     -0.101473322149     -0.000106754691`}
  caption="初期経路を求めるための初期構造"
  backgroundColor="#333333"
/>


### 2. 遷移状態構造最適化

　`run_autots.py`を適切に使用することで、自動的に遷移状態構造が得られる。以下にその手順を説明していく。

初期構造を`MultiOptPy-1.20.4`ディレクトリ内に`bh9_8_1.xyz`として保存する。その後、同じディレクトリ内で、`config_bh9_8_1.json`を作成し、以下のように記述する。

`config_bh9_8_1.json`
```json
{
  "work_dir": "bh9_8_1",
  "top_n_candidates": 3,
  "multioptpy_version": "1.20.4",
  
  "step1_settings": {
    "othersoft": "uma-s-1p1",
    "opt_method": ["rsirfo_block_fsb"],
    "use_model_hessian": "fischerd3",
    "spin_multiplicity": 1,
    "electronic_charge": -1, 
	"manual_AFIR": ["250", "8", "12"]
  },
  
  "step2_settings": {
    "othersoft": "uma-s-1p1",
    "NSTEP": 18,
    "use_model_hessian": "fischerd3",
    "save_pict": true,
	"QSMv2": true,
    "node_distance": 0.40,
    "align_distances_energy_predicted": 1,
    "spin_multiplicity": 1,
    "electronic_charge": -1
  },
  
  "step3_settings": {
    "othersoft": "uma-s-1p1",
    "opt_method": ["rsirfo_block_bofill"],
    "calc_exact_hess": 5,
    "tight_convergence_criteria": true,
    "max_trust_radius": 0.20,
	"min_trust_radius": 0.02,
    "frequency_analysis": true,
	"NSTEP": 500,
	"detect_negative_eigenvalues": false,
    "spin_multiplicity": 1,
    "electronic_charge": -1
  },

  "step4_settings": {
    "othersoft": "uma-s-1p1",
	"opt_method": ["rsirfo_block_bofill"],
    "spin_multiplicity": 1,
    "electronic_charge": -1,
	"calc_exact_hess": 10,
    "tight_convergence_criteria": true,
    "frequency_analysis": true,
    
    "intrinsic_reaction_coordinates": ["0.5", "200", "lqa"],

    "step4b_opt_method": ["rsirfo_block_fsb"]
  }
}
```
その後、以下のコマンドを実行する。
```
python run_autots.py bh9_8_1.xyz -cfg config_bh9_8_1.json
```

これにより、これまでの似た内容の記事で行ってきたコマンドの操作をまとめ、遷移状態構造を求める処理を自動的に行う。

具体的な処理の流れは、
```
Step1. バイアスポテンシャルによるNEB法のための初期経路の作成

Step2. NEB法による経路の緩和

Step3. NEB法により得られた経路のエネルギー極大値を示す構造のうち、エネルギー値が上位の最大で3個
(`run_autots.py`にて、`--top_n X`で最大値を変更可能)の構造を初期構造とした遷移状態構造の算出

(Step4.得られた遷移状態構造に対するIRC計算とIRC経路の末端に存在する構造に対する構造最適化。
こちらは`--run_step4`をコマンドで追記しなければ行わない。)
```
となっている。

`run_autots.py`のオプションの説明：

- `-cfg YYY.json`は、workflowを実行するためのオプションが記されたJSONファイルの読み込み先を指定する。


これらの一連の結果は、`(jsonファイルの"work_dir"にて指定した名前)`のディレクトリの中に存在するファイルを開いて確認できる。

以下にすべてのstepで共通のオプションに関する説明を載せる。

- `"opt_method": ["rsirfo_block_fsb"]`は準ニュートン法であるRS-I-RFO法を構造最適化に使用することを示す。初期のへシアンに関しては、特にオプションで指定しない限り、単位行列が使われる。(以前のHessian更新法とは細かな点で異なる方法を使用している。具体的には、複数の座標変位や勾配変位を用いてHessianの更新を行う。)
- `"spin_multiplicity": Z`はスピン多重度の指定である。PySCFを使用するときは目的とするスピン多重度に1を引いた値を指定する。（デフォルトでは1が指定される。）
- ` "electronic_charge": 0`は形式電荷をMとすることを示す。（デフォルトでは0が指定される。）
- `"othersoft": "uma-s-1p1"`は今回使用するNNPを指定している。これを使用する際にASEライブラリが必要である。
- `"use_model_hessian": "fischerd3"`は、計算コストが非常に低い数式を使用して、近似したHessianを生成する機能を呼び出すオプションである。デフォルトではこの機能は使用されない。


※オプションの説明は`MultiOptPy-v1.20.4/OPTION_README.md`にて示されている。


#### Step 1


Step1では、`omol`のデータセットを使用した`uma-s-1p1`モデルのNNPで得たエネルギーに対して、指定した人工力ポテンシャルを加えた上で初期構造を構造最適化を行っている。


以下のJSON内で記述したバイアスポテンシャルで、次の経路緩和アルゴリズムの初期経路として用いるトラジェクトリーを生成する。
- `"manual_AFIR": ["yyy", "a", "b]`：yyykJ/molの活性化障壁を超えうるペア同士を近づける力を原子のラベル番号aとbのペアに構造最適化時に加えることを示す。
-  `"shape_conditions": ["yyy", "lt", "a,b"]`: 構造最適化中に、ラベル番号aの原子とラベル番号bの原子の間の距離yyy(Å)よりも大きくなった時に構造最適化を途中で打ち切る。"lt"を"gt"にすると、yyy(Å)よりも小さくなった時に途中で打ち切る。
- `"shape_conditions": ["yyy", "lt", "a,b,c"]`: 構造最適化中に、角度の中心がラベル番号bの原子で、ラベル番号aの原子とラベル番号cで作る角度yyy(degrees)よりも大きくなった時に構造最適化を途中で打ち切る。"lt"を"gt"にすると、yyy(degrees)よりも小さくなった時に途中で打ち切る。
- `"shape_conditions": ["yyy", "lt", "a,b,c,d"]`: 構造最適化中に、ラベル番号bとラベル番号cを軸とした、ラベル番号aの原子とラベル番号dの原子がなす二面角yyy(degrees)よりも大きくなった時に構造最適化を途中で打ち切る。"lt"を"gt"にすると、yyy(degrees)よりも小さくなった時に途中で打ち切る。
- `"keep_pot": ["c", "d", "a,b"]`:力の定数`c` a.u.で、平行距離`d`Åの調和ポテンシャルを`a`番と`b`番の原子ペアにかける。初期経路生成時に開裂を防ぎたい結合を保持するとき等に使用する。

Step1が正常終了していれば作成された`work_dir`ディレクトリ中に、`bh9_8_1_step1_traj.xyz`が存在する。必要に応じて確認し、目的に沿った初期経路が得られているか確認する。もし想定とは異なる場合は、プロセスをkillして再度設定を見直してやり直す。


`bh9_8_1_step1_traj.xyz`は構造最適化の過程をAvogadro（公式ページ:https://avogadro.cc/ ）等で可視化して確認できるようにしている。この`bh9_8_1_step1_traj.xyz`はStep2のNEB計算に使用している。

※`bh9_8_1_step1_traj.xyz`をアニメーションとして表示したい場合は、[https://github.com/ss0832/molecule_movie] を使うと良い。


#### Step 2

Step2では、NEB法を用いることで、先ほど得られた`bh9_8_1_step1_traj.xyz`全体のエネルギーを下げることができる。これにより、パスのエネルギー極大値を持つ構造を遷移状態構造に近づける。（この時点ではまだ正確な遷移状態構造は求められていない。）

Step2固有のオプションについて以下に示す。


- `"NSTEP": n`はn回分NEB法による経路の緩和を行うことを示す。


- `"save_pict": true`は緩和中のパスのエネルギープロファイルや各ノードの勾配のRMS値をmatplotlibで可視化するオプションである。
- `"node_distance": yyy`: 入力された経路を経路座標上でyyy(Å)間隔で線形補間により構造を再配置して初期経路とする。
- `"align_distances_energy_predicted": a`:経路緩和a回に1回、経路座標上で等間隔に線形補間により構造を置きなおす。エネルギー極大値を示す構造に対しては前後のノードの情報を使って経路座標を変数とした多項式を作り、真のエネルギー極大値の場所を連続最適化により推定し、再配置する。


`MultiOptPy-v1.20.4/"work_dir"`と同じディレクトリ内に、NEBという名前を含むディレクトリが生成されている。
そのディレクトリ内の`energy_plot.csv`を確認し、緩和後のパスのエネルギー極大値を示す構造を確認する。

経路の緩和後の各ノードのエネルギー一覧(単位:hartree) (energy_plot.csvに保存されている。)

export const dataset1 = [-368.2849767580019,-368.2849767580019,-368.26987699720667,-368.2571969337847,-368.2452300577793,-368.2655116552121,-368.2913541496784,-368.30085576847216,-368.30417766432817,-368.30563480374354,-368.3057233321421,-368.30596152820755,-368.3064180487619,-368.3068180474735,-368.30708067120867,-368.30719571256594,-368.3073104034545,-368.30765459878415,-368.3077024377644,-368.30772865282466];

export const dataset1_itr5 = [-368.2851538892737,-368.28062147007876,-368.27504129397994,-368.2669906792085,-368.2668843404277,-368.28377916257784,-368.29731797074214,-368.30384628301107,-368.30711216958485,-368.30862697424715,-368.30900915162437,-368.30916984153237,-368.30941700083525,-368.30970202828337,-368.3100089687881,-368.31023321619847,-368.3103486255479,-368.3105102529597,-368.31087716742417,-368.3109521239216];

export const dataset1_itr10 = [-368.28532091390383,-368.28257234106474,-368.2822462080167,-368.2749536198489,-368.2673456908791,-368.2821269303688,-368.2975315814268,-368.30327336303316,-368.3064208262265,-368.3082906732254,-368.3089998379181,-368.3092278528672,-368.30942703300235,-368.30968064092974,-368.30988808336497,-368.3101306427659,-368.3104209447682,-368.31066038499756,-368.31081231318757,-368.3110310494773];

export const dataset2 = [-368.2854397666085,-368.2844221894423,-368.2835883893111,-368.27632464033803,-368.2687581301996,-368.28361520454905,-368.29932407997927,-368.30442764052344,-368.3064614630746,-368.30802895194716,-368.3088646971798,-368.3091287665984,-368.30937969344006,-368.30963940828485,-368.30992026515514,-368.3101837124918,-368.3104317041579,-368.31067616485166,-368.3109142119678,-368.31103228487956];

<MultiDataGraph datasets={[ { data: dataset1, label: "緩和前の経路のエネルギー", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_itr5, label: "ITR. 5の経路のエネルギー", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_itr10, label: "ITR. 10の経路のエネルギー", color: "rgba(81, 143, 18, 1)"}, { data: dataset2, label: "緩和後の経路のエネルギー", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="Electronic Energy [hartree]" height="500px" />

export const dataset1_grad = [0.0013773936783535309,0.0013773941111758948,0.00834468875853204,0.010395451890860273,0.019438017969400635,0.017046740016486425,0.014867112909629873,0.011853642394983288,0.01132397754726889,0.011723656096386917,0.01187836321291156,0.011713778252475075,0.01180953963338657,0.011679070508718954,0.011718593112378422,0.011621713131206156,0.011743520591174778,0.011547601773449339,0.01167772908589521,0.011698701127749097];

export const dataset1_grad_itr5 = [0.0009542710548503197,0.003762162445503026,0.005466305706345392,0.005400910597809088,0.008489388673339609,0.008135069455063319,0.003952054870821681,0.001935636392572623,0.0017726437404634555,0.0016033276317751234,0.0013636726480048306,0.0016673896618343558,0.001622801419722878,0.0015923474982081321,0.001554001679606775,0.0016066842400541729,0.0019640603651387314,0.002225882129699669,0.0012675489805189428,0.0016256826442418348];

export const dataset1_grad_itr10 = [0.0007520272114471615,0.002580663022876259,0.002493214756692847,0.00505279533921339,0.002853759405872763,0.008562336530720045,0.0035902649451611153,0.0018413699414197985,0.0024937666533458233,0.0015712039327890799,0.0009636995921520864,0.0007484528622285893,0.0010931413969573075,0.0010349038726093869,0.0020837119313882042,0.002243870106570277,0.0012256716548360363,0.0007898889766196193,0.0020617848325999596,0.00012579713617248282];

export const dataset2_grad = [0.000617897223121494,0.0013007586962060882,0.0014396889256908319,0.005109836167269178,0.0017064945650114675,0.008758577943006622,0.00288983435687529,0.001916086556378304,0.002226840342874417,0.0018735697913385212,0.0020713349527974206,0.0020950410265809893,0.0017746977279373636,0.00172354839085722,0.0016548414390550321,0.0018449206355964519,0.000857729441071833,0.0005905355222263617,0.0009879610985880627,5.781035880612615e-05];

<MultiDataGraph datasets={[ { data: dataset1_grad, label: "緩和前の経路の勾配のRMS値", color: "rgba(75, 192, 192, 1)" }, { data: dataset1_grad_itr5, label: "ITR. 5の経路の勾配のRMS値", color: "rgba(81, 43, 186, 1)" }, { data: dataset1_grad_itr10, label: "ITR. 10の経路の勾配のRMS値", color: "rgba(81, 143, 18, 1)"},  { data: dataset2_grad, label: "緩和後の経路の勾配のRMS値", color: "rgba(255, 99, 132, 1)" }, ]} title="NEB計算の結果の可視化" xLabel="# NODE" yLabel="RMS of gradient [hartree/Bohr]" height="500px" />

※`bias_force_rms.csv`にて、各Iterationごとのすべてのノードの勾配のRMS値を確認できる。

経路緩和の結果、以下の構造がstep3の初期構造として自動的に用いられた。"work_dir"内の`bh9_8_1_step3_TS_Opt_Inputs`内に保存された`bh9_8_1_ts_guess_X.xyz`にて確認が可能である。ts_guessの番号が小さい順にエネルギー値が高い構造を示すようになっている。

※こちら[https://ss0832.github.io/molecule_viewer/] を使うことでも可視化は可能である。


`bh9_8_1_ts_guess_1.xyz`
```
12
-1 1
C      -0.829638571928      0.410797671579      0.008253612995
O      -0.693460645860      1.630356146767      0.018581842611
C      -2.203865988520     -0.245818922362      0.001674517168
H      -2.275670189930     -0.900729795575      0.870939456601
H      -2.276202268995     -0.879953854625     -0.882873709721
H      -2.996483982074      0.495801507680      0.010401496714
O       0.089896395664     -0.485401220540      0.000344938603
C       1.823819705489     -0.059137989637     -0.004599582105
H       2.058011583888     -1.100552033761     -0.005451604119
H       1.797830384025      0.485885313684     -0.926643648502
H       1.801499978322      0.488142642307      0.916062653485
F       3.704263599918      0.160610534483     -0.006689973731
```

<MoleculeViewer 
  xyzData={`12
-1 1
C      -0.829638571928      0.410797671579      0.008253612995
O      -0.693460645860      1.630356146767      0.018581842611
C      -2.203865988520     -0.245818922362      0.001674517168
H      -2.275670189930     -0.900729795575      0.870939456601
H      -2.276202268995     -0.879953854625     -0.882873709721
H      -2.996483982074      0.495801507680      0.010401496714
O       0.089896395664     -0.485401220540      0.000344938603
C       1.823819705489     -0.059137989637     -0.004599582105
H       2.058011583888     -1.100552033761     -0.005451604119
H       1.797830384025      0.485885313684     -0.926643648502
H       1.801499978322      0.488142642307      0.916062653485
F       3.704263599918      0.160610534483     -0.006689973731`}
  caption="NEB法により緩和した経路から得られた遷移状態構造を求めるための初期構造 (No.1)"
  backgroundColor="#333333"
/>


#### Step 3

step3のオプションで、追加での説明を要するものを以下に示す。

- `"opt_method": ["rsirfo_block_bofill"]`は遷移状態構造の最適化向けのoptimizerを指定することを意味する。準ニュートン法であるRS-I-RFO法を使用する。今回は`-fc`で正確なHessianを計算するようにしているので、初期Hessianは正確なHessianを使用するようになっている。(Bofill法によるHessianの更新法を細かい点で変更している。具体的には、複数の座標変位や勾配変位を用いてHessianの更新を行う。)
- `"saddle_order": 1`は一次の鞍点を求めることを指定する。（step3のデフォルトでは一次の鞍点を指定する。それ以外の値の指定は、プログラムの使用目的上想定していないので、行わないことを勧める。）
- `"calc_exact_hess": 5`は5回の反復回数当たり1回正確なHessianを計算することを指定する。
- `"frequency_analysis": true`は収束条件を満たした後に基準振動解析を行うことを示す。（自前で実装しているため、あくまで目安として使用することを推奨する。各振動モードを`vibration_animation`内のxyzファイルで可視化できる。）UMAモデルから算出されるHessianは数値微分により求めているため、原子数Zが多いとZの二乗オーダーで計算コストが急増する。
- `"tight_convergence_criteria": true`は収束条件を厳しくすることを示す。（Gaussianのtightと同等）
- `"max_trust_radius": D`は一回の反復計算ごとの計算されるステップ幅の最大値をDÅ以下にすることを示す。デフォルトでは、`"saddle_order": 1`を指定すると0.1Åが指定される。
- `"detect_negative_eigenvalues": true`は、初めの計算時(ITR. 0)に、任意の次数の鞍点(遷移状態構造等)を求める際に、正確なへシアンから算出した固有値に１つも負の固有値がない場合、計算を打ち切るオプションである。

実行して得られた正確な遷移状態構造と思われる構造を以下に示す。

(実行して得られた正確な遷移状態構造は計算開始時に、`MultiOptPy-1.20.4/"work_dir"`ディレクトリ内に生成された新規ディレクトリ内の`bh9_8_1_ts_final_X.xyz`として保存されている。)

`bh9_8_1_ts_final_1.xyz`
```
12
OptimizedStructure
C     -0.801929571500      0.324647196770      0.005797297577
O     -0.614265620117      1.537109160967     -0.007828267685
C     -2.225298720983     -0.231428232497      0.005149199640
H     -2.349735873805     -0.939027136897      0.825291419214
H     -2.398455222609     -0.775403876341     -0.924709393048
H     -2.944804835861      0.579646335429      0.094335112377
O      0.097460049319     -0.595575757919      0.013800347714
C      1.829116715761     -0.072969807243      0.000495181779
H      2.139854718573     -1.097249476148      0.065558386646
H      1.780806248100      0.415038085774     -0.954240127094
H      1.761966380861      0.530948912297      0.885184993102
F      3.725285732262      0.324264595809     -0.008834150222
```

<MoleculeViewer 
  xyzData={`12
OptimizedStructure
C     -0.801929571500      0.324647196770      0.005797297577
O     -0.614265620117      1.537109160967     -0.007828267685
C     -2.225298720983     -0.231428232497      0.005149199640
H     -2.349735873805     -0.939027136897      0.825291419214
H     -2.398455222609     -0.775403876341     -0.924709393048
H     -2.944804835861      0.579646335429      0.094335112377
O      0.097460049319     -0.595575757919      0.013800347714
C      1.829116715761     -0.072969807243      0.000495181779
H      2.139854718573     -1.097249476148      0.065558386646
H      1.780806248100      0.415038085774     -0.954240127094
H      1.761966380861      0.530948912297      0.885184993102
F      3.725285732262      0.324264595809     -0.008834150222`}
  caption="遷移状態構造 (No.1)"
  backgroundColor="#333333"
/>


19回の反復計算により、停留点に収束した構造が得られた。`"frequency_analysis": true`オプションにより生成された`normal_modes.txt`や`vibration_animation`ディレクトリ内の振動モードのアニメーションを確認した。

以下に`"frequency_analysis": true`オプションで生成された`normal_modes.txt`の一部を示す。
```
Mode                                 0                   1                   2
Freq [cm^-1]                     -539.3223             29.2201             54.4932
Reduced mass [au]                  12.1737              1.1930              1.0829
Force const [Dyne/A]               -2.0863              0.0006              0.0019
Char temp [K]                       0.0000             42.0412             78.4035
Normal mode                   x         y         z            x         y         z            x         y         z     
       C                -0.01103   -0.01693    0.00070    0.00093   -0.00283    0.01952    0.00188   -0.00225   -0.00357
       O                -0.00448   -0.00029    0.00004    0.00041   -0.00316   -0.02722    0.00720   -0.00360   -0.05471
       C                -0.02707    0.01101    0.00014   -0.00123    0.00309   -0.04387   -0.00073    0.00427    0.01132
       H                -0.02601    0.00919   -0.00020    0.08174   -0.40398   -0.38558    0.00464   -0.00377    0.00495
       H                -0.02266    0.00739    0.00065   -0.11092    0.47485   -0.30173   -0.01434    0.01584    0.00689
       H                -0.03350    0.00762   -0.00141    0.01522   -0.03169    0.40918    0.00448    0.00739    0.02549
       O                -0.06404   -0.01806   -0.00033    0.00114   -0.00181    0.07855   -0.00115   -0.00460    0.03459
       C                 0.25370    0.05245   -0.00075    0.00029   -0.00016    0.02494   -0.00130    0.00050    0.01527
       H                -0.01486   -0.02766    0.00353    0.00274    0.00379    0.07558    0.00539   -0.03187   -0.52596
       H                -0.00374   -0.00212   -0.01244   -0.01670   -0.05206   -0.00082   -0.13156    0.48164    0.26822
       H                -0.00545    0.00365    0.00964    0.01432    0.04773   -0.00676    0.11829   -0.44377    0.32800
       F                -0.07286   -0.01384    0.00020   -0.00057    0.00207   -0.03244   -0.00430    0.00397   -0.00331
       
(...snip...)
```
その結果、虚振動が１つであることが確認できた。つまりこの構造は遷移状態構造である。


次に、`vibration_animation`内の虚振動を示す分子振動が示されたxyzファイル(`mode_1_XXXi_wave_number.xyz`)をAvogadroで確認すると、求められた遷移状態構造の中に、想定される反応系と生成系をつなぐ方向に振動している構造が存在することを確認できた。


## 終わりに
　
　自作ライブラリで、UMAモデルのニューラルネットワークポテンシャル(NNP, `uma-s-1p1`)を用いて、BH9データセットの8. Nucleophilic substitution, No. 1の化学反応の反応のある1つの遷移状態構造を算出する手順を説明した。



## 参考
- https://github.com/ss0832/MultiOptPy (自作ライブラリMultiOptPyのレポジトリ)
- https://avogadro.cc/ (Avogadro、分子構造可視化ツール)
- https://ai.meta.com/blog/meta-fair-science-new-open-source-releases/ (UMAの公開に関する記事)
- https://github.com/facebookresearch/fairchem (FAIR Chemistryの提供するGitHubのレポジトリ)
- https://fair-chem.github.io/ (同上のレポジトリの内容に関して説明したサイト)
- https://huggingface.co/facebook/UMA (NNPの配布サイト, Hugging Faceへのアカウント登録と配布元の使用許諾が必要である。)
- arXiv preprint arXiv:2505.08762 (2025). (プレプリント)
- _The Journal of Chemical Physics_ 2010, 132, 241102.
- _The Journal of Chemical Physics_ 1991, 94, 751–760.
- In _Classical and Quantum Dynamics in Condensed Phase Simulations_; WORLD SCIENTIFIC: LERICI, Villa Marigola, 1998; pp 385–404.
- _The Journal of Chemical Physics_, 2020, 153, 024109.
- _The Journal of Chemical Physics_, 2022, 144, 214108.
